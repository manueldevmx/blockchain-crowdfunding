{"ast":null,"code":"var original = require('original');\n\nvar parse = require('url').parse;\n\nvar events = require('events');\n\nvar https = require('https');\n\nvar http = require('http');\n\nvar util = require('util');\n\nvar httpsOptions = ['pfx', 'key', 'passphrase', 'cert', 'ca', 'ciphers', 'rejectUnauthorized', 'secureProtocol', 'servername', 'checkServerIdentity'];\nvar bom = [239, 187, 191];\nvar colon = 58;\nvar space = 32;\nvar lineFeed = 10;\nvar carriageReturn = 13;\n\nfunction hasBom(buf) {\n  return bom.every(function (charCode, index) {\n    return buf[index] === charCode;\n  });\n}\n/**\n * Creates a new EventSource object\n *\n * @param {String} url the URL to which to connect\n * @param {Object} [eventSourceInitDict] extra init params. See README for details.\n * @api public\n **/\n\n\nfunction EventSource(url, eventSourceInitDict) {\n  var readyState = EventSource.CONNECTING;\n  Object.defineProperty(this, 'readyState', {\n    get: function () {\n      return readyState;\n    }\n  });\n  Object.defineProperty(this, 'url', {\n    get: function () {\n      return url;\n    }\n  });\n  var self = this;\n  self.reconnectInterval = 1000;\n\n  function onConnectionClosed(message) {\n    if (readyState === EventSource.CLOSED) return;\n    readyState = EventSource.CONNECTING;\n\n    _emit('error', new Event('error', {\n      message: message\n    })); // The url may have been changed by a temporary\n    // redirect. If that's the case, revert it now.\n\n\n    if (reconnectUrl) {\n      url = reconnectUrl;\n      reconnectUrl = null;\n    }\n\n    setTimeout(function () {\n      if (readyState !== EventSource.CONNECTING) {\n        return;\n      }\n\n      connect();\n    }, self.reconnectInterval);\n  }\n\n  var req;\n  var lastEventId = '';\n\n  if (eventSourceInitDict && eventSourceInitDict.headers && eventSourceInitDict.headers['Last-Event-ID']) {\n    lastEventId = eventSourceInitDict.headers['Last-Event-ID'];\n    delete eventSourceInitDict.headers['Last-Event-ID'];\n  }\n\n  var discardTrailingNewline = false;\n  var data = '';\n  var eventName = '';\n  var reconnectUrl = null;\n\n  function connect() {\n    var options = parse(url);\n    var isSecure = options.protocol === 'https:';\n    options.headers = {\n      'Cache-Control': 'no-cache',\n      'Accept': 'text/event-stream'\n    };\n    if (lastEventId) options.headers['Last-Event-ID'] = lastEventId;\n\n    if (eventSourceInitDict && eventSourceInitDict.headers) {\n      for (var i in eventSourceInitDict.headers) {\n        var header = eventSourceInitDict.headers[i];\n\n        if (header) {\n          options.headers[i] = header;\n        }\n      }\n    } // Legacy: this should be specified as `eventSourceInitDict.https.rejectUnauthorized`,\n    // but for now exists as a backwards-compatibility layer\n\n\n    options.rejectUnauthorized = !(eventSourceInitDict && !eventSourceInitDict.rejectUnauthorized); // If specify http proxy, make the request to sent to the proxy server,\n    // and include the original url in path and Host headers\n\n    var useProxy = eventSourceInitDict && eventSourceInitDict.proxy;\n\n    if (useProxy) {\n      var proxy = parse(eventSourceInitDict.proxy);\n      isSecure = proxy.protocol === 'https:';\n      options.protocol = isSecure ? 'https:' : 'http:';\n      options.path = url;\n      options.headers.Host = options.host;\n      options.hostname = proxy.hostname;\n      options.host = proxy.host;\n      options.port = proxy.port;\n    } // If https options are specified, merge them into the request options\n\n\n    if (eventSourceInitDict && eventSourceInitDict.https) {\n      for (var optName in eventSourceInitDict.https) {\n        if (httpsOptions.indexOf(optName) === -1) {\n          continue;\n        }\n\n        var option = eventSourceInitDict.https[optName];\n\n        if (option !== undefined) {\n          options[optName] = option;\n        }\n      }\n    } // Pass this on to the XHR\n\n\n    if (eventSourceInitDict && eventSourceInitDict.withCredentials !== undefined) {\n      options.withCredentials = eventSourceInitDict.withCredentials;\n    }\n\n    req = (isSecure ? https : http).request(options, function (res) {\n      // Handle HTTP errors\n      if (res.statusCode === 500 || res.statusCode === 502 || res.statusCode === 503 || res.statusCode === 504) {\n        _emit('error', new Event('error', {\n          status: res.statusCode,\n          message: res.statusMessage\n        }));\n\n        onConnectionClosed();\n        return;\n      } // Handle HTTP redirects\n\n\n      if (res.statusCode === 301 || res.statusCode === 307) {\n        if (!res.headers.location) {\n          // Server sent redirect response without Location header.\n          _emit('error', new Event('error', {\n            status: res.statusCode,\n            message: res.statusMessage\n          }));\n\n          return;\n        }\n\n        if (res.statusCode === 307) reconnectUrl = url;\n        url = res.headers.location;\n        process.nextTick(connect);\n        return;\n      }\n\n      if (res.statusCode !== 200) {\n        _emit('error', new Event('error', {\n          status: res.statusCode,\n          message: res.statusMessage\n        }));\n\n        return self.close();\n      }\n\n      readyState = EventSource.OPEN;\n      res.on('close', function () {\n        res.removeAllListeners('close');\n        res.removeAllListeners('end');\n        onConnectionClosed();\n      });\n      res.on('end', function () {\n        res.removeAllListeners('close');\n        res.removeAllListeners('end');\n        onConnectionClosed();\n      });\n\n      _emit('open', new Event('open')); // text/event-stream parser adapted from webkit's\n      // Source/WebCore/page/EventSource.cpp\n\n\n      var isFirst = true;\n      var buf;\n      res.on('data', function (chunk) {\n        buf = buf ? Buffer.concat([buf, chunk]) : chunk;\n\n        if (isFirst && hasBom(buf)) {\n          buf = buf.slice(bom.length);\n        }\n\n        isFirst = false;\n        var pos = 0;\n        var length = buf.length;\n\n        while (pos < length) {\n          if (discardTrailingNewline) {\n            if (buf[pos] === lineFeed) {\n              ++pos;\n            }\n\n            discardTrailingNewline = false;\n          }\n\n          var lineLength = -1;\n          var fieldLength = -1;\n          var c;\n\n          for (var i = pos; lineLength < 0 && i < length; ++i) {\n            c = buf[i];\n\n            if (c === colon) {\n              if (fieldLength < 0) {\n                fieldLength = i - pos;\n              }\n            } else if (c === carriageReturn) {\n              discardTrailingNewline = true;\n              lineLength = i - pos;\n            } else if (c === lineFeed) {\n              lineLength = i - pos;\n            }\n          }\n\n          if (lineLength < 0) {\n            break;\n          }\n\n          parseEventStreamLine(buf, pos, fieldLength, lineLength);\n          pos += lineLength + 1;\n        }\n\n        if (pos === length) {\n          buf = void 0;\n        } else if (pos > 0) {\n          buf = buf.slice(pos);\n        }\n      });\n    });\n    req.on('error', function (err) {\n      onConnectionClosed(err.message);\n    });\n    if (req.setNoDelay) req.setNoDelay(true);\n    req.end();\n  }\n\n  connect();\n\n  function _emit() {\n    if (self.listeners(arguments[0]).length > 0) {\n      self.emit.apply(self, arguments);\n    }\n  }\n\n  this._close = function () {\n    if (readyState === EventSource.CLOSED) return;\n    readyState = EventSource.CLOSED;\n    if (req.abort) req.abort();\n    if (req.xhr && req.xhr.abort) req.xhr.abort();\n  };\n\n  function parseEventStreamLine(buf, pos, fieldLength, lineLength) {\n    if (lineLength === 0) {\n      if (data.length > 0) {\n        var type = eventName || 'message';\n\n        _emit(type, new MessageEvent(type, {\n          data: data.slice(0, -1),\n          // remove trailing newline\n          lastEventId: lastEventId,\n          origin: original(url)\n        }));\n\n        data = '';\n      }\n\n      eventName = void 0;\n    } else if (fieldLength > 0) {\n      var noValue = fieldLength < 0;\n      var step = 0;\n      var field = buf.slice(pos, pos + (noValue ? lineLength : fieldLength)).toString();\n\n      if (noValue) {\n        step = lineLength;\n      } else if (buf[pos + fieldLength + 1] !== space) {\n        step = fieldLength + 1;\n      } else {\n        step = fieldLength + 2;\n      }\n\n      pos += step;\n      var valueLength = lineLength - step;\n      var value = buf.slice(pos, pos + valueLength).toString();\n\n      if (field === 'data') {\n        data += value + '\\n';\n      } else if (field === 'event') {\n        eventName = value;\n      } else if (field === 'id') {\n        lastEventId = value;\n      } else if (field === 'retry') {\n        var retry = parseInt(value, 10);\n\n        if (!Number.isNaN(retry)) {\n          self.reconnectInterval = retry;\n        }\n      }\n    }\n  }\n}\n\nmodule.exports = EventSource;\nutil.inherits(EventSource, events.EventEmitter);\nEventSource.prototype.constructor = EventSource; // make stacktraces readable\n\n['open', 'error', 'message'].forEach(function (method) {\n  Object.defineProperty(EventSource.prototype, 'on' + method, {\n    /**\n     * Returns the current listener\n     *\n     * @return {Mixed} the set function or undefined\n     * @api private\n     */\n    get: function get() {\n      var listener = this.listeners(method)[0];\n      return listener ? listener._listener ? listener._listener : listener : undefined;\n    },\n\n    /**\n     * Start listening for events\n     *\n     * @param {Function} listener the listener\n     * @return {Mixed} the set function or undefined\n     * @api private\n     */\n    set: function set(listener) {\n      this.removeAllListeners(method);\n      this.addEventListener(method, listener);\n    }\n  });\n});\n/**\n * Ready states\n */\n\nObject.defineProperty(EventSource, 'CONNECTING', {\n  enumerable: true,\n  value: 0\n});\nObject.defineProperty(EventSource, 'OPEN', {\n  enumerable: true,\n  value: 1\n});\nObject.defineProperty(EventSource, 'CLOSED', {\n  enumerable: true,\n  value: 2\n});\nEventSource.prototype.CONNECTING = 0;\nEventSource.prototype.OPEN = 1;\nEventSource.prototype.CLOSED = 2;\n/**\n * Closes the connection, if one is made, and sets the readyState attribute to 2 (closed)\n *\n * @see https://developer.mozilla.org/en-US/docs/Web/API/EventSource/close\n * @api public\n */\n\nEventSource.prototype.close = function () {\n  this._close();\n};\n/**\n * Emulates the W3C Browser based WebSocket interface using addEventListener.\n *\n * @param {String} type A string representing the event type to listen out for\n * @param {Function} listener callback\n * @see https://developer.mozilla.org/en/DOM/element.addEventListener\n * @see http://dev.w3.org/html5/websockets/#the-websocket-interface\n * @api public\n */\n\n\nEventSource.prototype.addEventListener = function addEventListener(type, listener) {\n  if (typeof listener === 'function') {\n    // store a reference so we can return the original function again\n    listener._listener = listener;\n    this.on(type, listener);\n  }\n};\n/**\n * Emulates the W3C Browser based WebSocket interface using dispatchEvent.\n *\n * @param {Event} event An event to be dispatched\n * @see https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/dispatchEvent\n * @api public\n */\n\n\nEventSource.prototype.dispatchEvent = function dispatchEvent(event) {\n  if (!event.type) {\n    throw new Error('UNSPECIFIED_EVENT_TYPE_ERR');\n  } // if event is instance of an CustomEvent (or has 'details' property),\n  // send the detail object as the payload for the event\n\n\n  this.emit(event.type, event.detail);\n};\n/**\n * Emulates the W3C Browser based WebSocket interface using removeEventListener.\n *\n * @param {String} type A string representing the event type to remove\n * @param {Function} listener callback\n * @see https://developer.mozilla.org/en/DOM/element.removeEventListener\n * @see http://dev.w3.org/html5/websockets/#the-websocket-interface\n * @api public\n */\n\n\nEventSource.prototype.removeEventListener = function removeEventListener(type, listener) {\n  if (typeof listener === 'function') {\n    listener._listener = undefined;\n    this.removeListener(type, listener);\n  }\n};\n/**\n * W3C Event\n *\n * @see http://www.w3.org/TR/DOM-Level-3-Events/#interface-Event\n * @api private\n */\n\n\nfunction Event(type, optionalProperties) {\n  Object.defineProperty(this, 'type', {\n    writable: false,\n    value: type,\n    enumerable: true\n  });\n\n  if (optionalProperties) {\n    for (var f in optionalProperties) {\n      if (optionalProperties.hasOwnProperty(f)) {\n        Object.defineProperty(this, f, {\n          writable: false,\n          value: optionalProperties[f],\n          enumerable: true\n        });\n      }\n    }\n  }\n}\n/**\n * W3C MessageEvent\n *\n * @see http://www.w3.org/TR/webmessaging/#event-definitions\n * @api private\n */\n\n\nfunction MessageEvent(type, eventInitDict) {\n  Object.defineProperty(this, 'type', {\n    writable: false,\n    value: type,\n    enumerable: true\n  });\n\n  for (var f in eventInitDict) {\n    if (eventInitDict.hasOwnProperty(f)) {\n      Object.defineProperty(this, f, {\n        writable: false,\n        value: eventInitDict[f],\n        enumerable: true\n      });\n    }\n  }\n}","map":{"version":3,"sources":["/home/manuel/Escritorio/blockchain_code/blockchain-crowdfunding/node_modules/eventsource/lib/eventsource.js"],"names":["original","require","parse","events","https","http","util","httpsOptions","bom","colon","space","lineFeed","carriageReturn","hasBom","buf","every","charCode","index","EventSource","url","eventSourceInitDict","readyState","CONNECTING","Object","defineProperty","get","self","reconnectInterval","onConnectionClosed","message","CLOSED","_emit","Event","reconnectUrl","setTimeout","connect","req","lastEventId","headers","discardTrailingNewline","data","eventName","options","isSecure","protocol","i","header","rejectUnauthorized","useProxy","proxy","path","Host","host","hostname","port","optName","indexOf","option","undefined","withCredentials","request","res","statusCode","status","statusMessage","location","process","nextTick","close","OPEN","on","removeAllListeners","isFirst","chunk","Buffer","concat","slice","length","pos","lineLength","fieldLength","c","parseEventStreamLine","err","setNoDelay","end","listeners","arguments","emit","apply","_close","abort","xhr","type","MessageEvent","origin","noValue","step","field","toString","valueLength","value","retry","parseInt","Number","isNaN","module","exports","inherits","EventEmitter","prototype","constructor","forEach","method","listener","_listener","set","addEventListener","enumerable","dispatchEvent","event","Error","detail","removeEventListener","removeListener","optionalProperties","writable","f","hasOwnProperty","eventInitDict"],"mappings":"AAAA,IAAIA,QAAQ,GAAGC,OAAO,CAAC,UAAD,CAAtB;;AACA,IAAIC,KAAK,GAAGD,OAAO,CAAC,KAAD,CAAP,CAAeC,KAA3B;;AACA,IAAIC,MAAM,GAAGF,OAAO,CAAC,QAAD,CAApB;;AACA,IAAIG,KAAK,GAAGH,OAAO,CAAC,OAAD,CAAnB;;AACA,IAAII,IAAI,GAAGJ,OAAO,CAAC,MAAD,CAAlB;;AACA,IAAIK,IAAI,GAAGL,OAAO,CAAC,MAAD,CAAlB;;AAEA,IAAIM,YAAY,GAAG,CACjB,KADiB,EACV,KADU,EACH,YADG,EACW,MADX,EACmB,IADnB,EACyB,SADzB,EAEjB,oBAFiB,EAEK,gBAFL,EAEuB,YAFvB,EAEqC,qBAFrC,CAAnB;AAKA,IAAIC,GAAG,GAAG,CAAC,GAAD,EAAM,GAAN,EAAW,GAAX,CAAV;AACA,IAAIC,KAAK,GAAG,EAAZ;AACA,IAAIC,KAAK,GAAG,EAAZ;AACA,IAAIC,QAAQ,GAAG,EAAf;AACA,IAAIC,cAAc,GAAG,EAArB;;AAEA,SAASC,MAAT,CAAiBC,GAAjB,EAAsB;AACpB,SAAON,GAAG,CAACO,KAAJ,CAAU,UAAUC,QAAV,EAAoBC,KAApB,EAA2B;AAC1C,WAAOH,GAAG,CAACG,KAAD,CAAH,KAAeD,QAAtB;AACD,GAFM,CAAP;AAGD;AAED;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,SAASE,WAAT,CAAsBC,GAAtB,EAA2BC,mBAA3B,EAAgD;AAC9C,MAAIC,UAAU,GAAGH,WAAW,CAACI,UAA7B;AACAC,EAAAA,MAAM,CAACC,cAAP,CAAsB,IAAtB,EAA4B,YAA5B,EAA0C;AACxCC,IAAAA,GAAG,EAAE,YAAY;AACf,aAAOJ,UAAP;AACD;AAHuC,GAA1C;AAMAE,EAAAA,MAAM,CAACC,cAAP,CAAsB,IAAtB,EAA4B,KAA5B,EAAmC;AACjCC,IAAAA,GAAG,EAAE,YAAY;AACf,aAAON,GAAP;AACD;AAHgC,GAAnC;AAMA,MAAIO,IAAI,GAAG,IAAX;AACAA,EAAAA,IAAI,CAACC,iBAAL,GAAyB,IAAzB;;AAEA,WAASC,kBAAT,CAA6BC,OAA7B,EAAsC;AACpC,QAAIR,UAAU,KAAKH,WAAW,CAACY,MAA/B,EAAuC;AACvCT,IAAAA,UAAU,GAAGH,WAAW,CAACI,UAAzB;;AACAS,IAAAA,KAAK,CAAC,OAAD,EAAU,IAAIC,KAAJ,CAAU,OAAV,EAAmB;AAACH,MAAAA,OAAO,EAAEA;AAAV,KAAnB,CAAV,CAAL,CAHoC,CAKpC;AACA;;;AACA,QAAII,YAAJ,EAAkB;AAChBd,MAAAA,GAAG,GAAGc,YAAN;AACAA,MAAAA,YAAY,GAAG,IAAf;AACD;;AACDC,IAAAA,UAAU,CAAC,YAAY;AACrB,UAAIb,UAAU,KAAKH,WAAW,CAACI,UAA/B,EAA2C;AACzC;AACD;;AACDa,MAAAA,OAAO;AACR,KALS,EAKPT,IAAI,CAACC,iBALE,CAAV;AAMD;;AAED,MAAIS,GAAJ;AACA,MAAIC,WAAW,GAAG,EAAlB;;AACA,MAAIjB,mBAAmB,IAAIA,mBAAmB,CAACkB,OAA3C,IAAsDlB,mBAAmB,CAACkB,OAApB,CAA4B,eAA5B,CAA1D,EAAwG;AACtGD,IAAAA,WAAW,GAAGjB,mBAAmB,CAACkB,OAApB,CAA4B,eAA5B,CAAd;AACA,WAAOlB,mBAAmB,CAACkB,OAApB,CAA4B,eAA5B,CAAP;AACD;;AAED,MAAIC,sBAAsB,GAAG,KAA7B;AACA,MAAIC,IAAI,GAAG,EAAX;AACA,MAAIC,SAAS,GAAG,EAAhB;AAEA,MAAIR,YAAY,GAAG,IAAnB;;AAEA,WAASE,OAAT,GAAoB;AAClB,QAAIO,OAAO,GAAGxC,KAAK,CAACiB,GAAD,CAAnB;AACA,QAAIwB,QAAQ,GAAGD,OAAO,CAACE,QAAR,KAAqB,QAApC;AACAF,IAAAA,OAAO,CAACJ,OAAR,GAAkB;AAAE,uBAAiB,UAAnB;AAA+B,gBAAU;AAAzC,KAAlB;AACA,QAAID,WAAJ,EAAiBK,OAAO,CAACJ,OAAR,CAAgB,eAAhB,IAAmCD,WAAnC;;AACjB,QAAIjB,mBAAmB,IAAIA,mBAAmB,CAACkB,OAA/C,EAAwD;AACtD,WAAK,IAAIO,CAAT,IAAczB,mBAAmB,CAACkB,OAAlC,EAA2C;AACzC,YAAIQ,MAAM,GAAG1B,mBAAmB,CAACkB,OAApB,CAA4BO,CAA5B,CAAb;;AACA,YAAIC,MAAJ,EAAY;AACVJ,UAAAA,OAAO,CAACJ,OAAR,CAAgBO,CAAhB,IAAqBC,MAArB;AACD;AACF;AACF,KAZiB,CAclB;AACA;;;AACAJ,IAAAA,OAAO,CAACK,kBAAR,GAA6B,EAAE3B,mBAAmB,IAAI,CAACA,mBAAmB,CAAC2B,kBAA9C,CAA7B,CAhBkB,CAkBlB;AACA;;AACA,QAAIC,QAAQ,GAAG5B,mBAAmB,IAAIA,mBAAmB,CAAC6B,KAA1D;;AACA,QAAID,QAAJ,EAAc;AACZ,UAAIC,KAAK,GAAG/C,KAAK,CAACkB,mBAAmB,CAAC6B,KAArB,CAAjB;AACAN,MAAAA,QAAQ,GAAGM,KAAK,CAACL,QAAN,KAAmB,QAA9B;AAEAF,MAAAA,OAAO,CAACE,QAAR,GAAmBD,QAAQ,GAAG,QAAH,GAAc,OAAzC;AACAD,MAAAA,OAAO,CAACQ,IAAR,GAAe/B,GAAf;AACAuB,MAAAA,OAAO,CAACJ,OAAR,CAAgBa,IAAhB,GAAuBT,OAAO,CAACU,IAA/B;AACAV,MAAAA,OAAO,CAACW,QAAR,GAAmBJ,KAAK,CAACI,QAAzB;AACAX,MAAAA,OAAO,CAACU,IAAR,GAAeH,KAAK,CAACG,IAArB;AACAV,MAAAA,OAAO,CAACY,IAAR,GAAeL,KAAK,CAACK,IAArB;AACD,KA/BiB,CAiClB;;;AACA,QAAIlC,mBAAmB,IAAIA,mBAAmB,CAAChB,KAA/C,EAAsD;AACpD,WAAK,IAAImD,OAAT,IAAoBnC,mBAAmB,CAAChB,KAAxC,EAA+C;AAC7C,YAAIG,YAAY,CAACiD,OAAb,CAAqBD,OAArB,MAAkC,CAAC,CAAvC,EAA0C;AACxC;AACD;;AAED,YAAIE,MAAM,GAAGrC,mBAAmB,CAAChB,KAApB,CAA0BmD,OAA1B,CAAb;;AACA,YAAIE,MAAM,KAAKC,SAAf,EAA0B;AACxBhB,UAAAA,OAAO,CAACa,OAAD,CAAP,GAAmBE,MAAnB;AACD;AACF;AACF,KA7CiB,CA+ClB;;;AACA,QAAIrC,mBAAmB,IAAIA,mBAAmB,CAACuC,eAApB,KAAwCD,SAAnE,EAA8E;AAC5EhB,MAAAA,OAAO,CAACiB,eAAR,GAA0BvC,mBAAmB,CAACuC,eAA9C;AACD;;AAEDvB,IAAAA,GAAG,GAAG,CAACO,QAAQ,GAAGvC,KAAH,GAAWC,IAApB,EAA0BuD,OAA1B,CAAkClB,OAAlC,EAA2C,UAAUmB,GAAV,EAAe;AAC9D;AACA,UAAIA,GAAG,CAACC,UAAJ,KAAmB,GAAnB,IAA0BD,GAAG,CAACC,UAAJ,KAAmB,GAA7C,IAAoDD,GAAG,CAACC,UAAJ,KAAmB,GAAvE,IAA8ED,GAAG,CAACC,UAAJ,KAAmB,GAArG,EAA0G;AACxG/B,QAAAA,KAAK,CAAC,OAAD,EAAU,IAAIC,KAAJ,CAAU,OAAV,EAAmB;AAAC+B,UAAAA,MAAM,EAAEF,GAAG,CAACC,UAAb;AAAyBjC,UAAAA,OAAO,EAAEgC,GAAG,CAACG;AAAtC,SAAnB,CAAV,CAAL;;AACApC,QAAAA,kBAAkB;AAClB;AACD,OAN6D,CAQ9D;;;AACA,UAAIiC,GAAG,CAACC,UAAJ,KAAmB,GAAnB,IAA0BD,GAAG,CAACC,UAAJ,KAAmB,GAAjD,EAAsD;AACpD,YAAI,CAACD,GAAG,CAACvB,OAAJ,CAAY2B,QAAjB,EAA2B;AACzB;AACAlC,UAAAA,KAAK,CAAC,OAAD,EAAU,IAAIC,KAAJ,CAAU,OAAV,EAAmB;AAAC+B,YAAAA,MAAM,EAAEF,GAAG,CAACC,UAAb;AAAyBjC,YAAAA,OAAO,EAAEgC,GAAG,CAACG;AAAtC,WAAnB,CAAV,CAAL;;AACA;AACD;;AACD,YAAIH,GAAG,CAACC,UAAJ,KAAmB,GAAvB,EAA4B7B,YAAY,GAAGd,GAAf;AAC5BA,QAAAA,GAAG,GAAG0C,GAAG,CAACvB,OAAJ,CAAY2B,QAAlB;AACAC,QAAAA,OAAO,CAACC,QAAR,CAAiBhC,OAAjB;AACA;AACD;;AAED,UAAI0B,GAAG,CAACC,UAAJ,KAAmB,GAAvB,EAA4B;AAC1B/B,QAAAA,KAAK,CAAC,OAAD,EAAU,IAAIC,KAAJ,CAAU,OAAV,EAAmB;AAAC+B,UAAAA,MAAM,EAAEF,GAAG,CAACC,UAAb;AAAyBjC,UAAAA,OAAO,EAAEgC,GAAG,CAACG;AAAtC,SAAnB,CAAV,CAAL;;AACA,eAAOtC,IAAI,CAAC0C,KAAL,EAAP;AACD;;AAED/C,MAAAA,UAAU,GAAGH,WAAW,CAACmD,IAAzB;AACAR,MAAAA,GAAG,CAACS,EAAJ,CAAO,OAAP,EAAgB,YAAY;AAC1BT,QAAAA,GAAG,CAACU,kBAAJ,CAAuB,OAAvB;AACAV,QAAAA,GAAG,CAACU,kBAAJ,CAAuB,KAAvB;AACA3C,QAAAA,kBAAkB;AACnB,OAJD;AAMAiC,MAAAA,GAAG,CAACS,EAAJ,CAAO,KAAP,EAAc,YAAY;AACxBT,QAAAA,GAAG,CAACU,kBAAJ,CAAuB,OAAvB;AACAV,QAAAA,GAAG,CAACU,kBAAJ,CAAuB,KAAvB;AACA3C,QAAAA,kBAAkB;AACnB,OAJD;;AAKAG,MAAAA,KAAK,CAAC,MAAD,EAAS,IAAIC,KAAJ,CAAU,MAAV,CAAT,CAAL,CAtC8D,CAwC9D;AACA;;;AACA,UAAIwC,OAAO,GAAG,IAAd;AACA,UAAI1D,GAAJ;AACA+C,MAAAA,GAAG,CAACS,EAAJ,CAAO,MAAP,EAAe,UAAUG,KAAV,EAAiB;AAC9B3D,QAAAA,GAAG,GAAGA,GAAG,GAAG4D,MAAM,CAACC,MAAP,CAAc,CAAC7D,GAAD,EAAM2D,KAAN,CAAd,CAAH,GAAiCA,KAA1C;;AACA,YAAID,OAAO,IAAI3D,MAAM,CAACC,GAAD,CAArB,EAA4B;AAC1BA,UAAAA,GAAG,GAAGA,GAAG,CAAC8D,KAAJ,CAAUpE,GAAG,CAACqE,MAAd,CAAN;AACD;;AAEDL,QAAAA,OAAO,GAAG,KAAV;AACA,YAAIM,GAAG,GAAG,CAAV;AACA,YAAID,MAAM,GAAG/D,GAAG,CAAC+D,MAAjB;;AAEA,eAAOC,GAAG,GAAGD,MAAb,EAAqB;AACnB,cAAItC,sBAAJ,EAA4B;AAC1B,gBAAIzB,GAAG,CAACgE,GAAD,CAAH,KAAanE,QAAjB,EAA2B;AACzB,gBAAEmE,GAAF;AACD;;AACDvC,YAAAA,sBAAsB,GAAG,KAAzB;AACD;;AAED,cAAIwC,UAAU,GAAG,CAAC,CAAlB;AACA,cAAIC,WAAW,GAAG,CAAC,CAAnB;AACA,cAAIC,CAAJ;;AAEA,eAAK,IAAIpC,CAAC,GAAGiC,GAAb,EAAkBC,UAAU,GAAG,CAAb,IAAkBlC,CAAC,GAAGgC,MAAxC,EAAgD,EAAEhC,CAAlD,EAAqD;AACnDoC,YAAAA,CAAC,GAAGnE,GAAG,CAAC+B,CAAD,CAAP;;AACA,gBAAIoC,CAAC,KAAKxE,KAAV,EAAiB;AACf,kBAAIuE,WAAW,GAAG,CAAlB,EAAqB;AACnBA,gBAAAA,WAAW,GAAGnC,CAAC,GAAGiC,GAAlB;AACD;AACF,aAJD,MAIO,IAAIG,CAAC,KAAKrE,cAAV,EAA0B;AAC/B2B,cAAAA,sBAAsB,GAAG,IAAzB;AACAwC,cAAAA,UAAU,GAAGlC,CAAC,GAAGiC,GAAjB;AACD,aAHM,MAGA,IAAIG,CAAC,KAAKtE,QAAV,EAAoB;AACzBoE,cAAAA,UAAU,GAAGlC,CAAC,GAAGiC,GAAjB;AACD;AACF;;AAED,cAAIC,UAAU,GAAG,CAAjB,EAAoB;AAClB;AACD;;AAEDG,UAAAA,oBAAoB,CAACpE,GAAD,EAAMgE,GAAN,EAAWE,WAAX,EAAwBD,UAAxB,CAApB;AAEAD,UAAAA,GAAG,IAAIC,UAAU,GAAG,CAApB;AACD;;AAED,YAAID,GAAG,KAAKD,MAAZ,EAAoB;AAClB/D,UAAAA,GAAG,GAAG,KAAK,CAAX;AACD,SAFD,MAEO,IAAIgE,GAAG,GAAG,CAAV,EAAa;AAClBhE,UAAAA,GAAG,GAAGA,GAAG,CAAC8D,KAAJ,CAAUE,GAAV,CAAN;AACD;AACF,OAlDD;AAmDD,KA/FK,CAAN;AAiGA1C,IAAAA,GAAG,CAACkC,EAAJ,CAAO,OAAP,EAAgB,UAAUa,GAAV,EAAe;AAC7BvD,MAAAA,kBAAkB,CAACuD,GAAG,CAACtD,OAAL,CAAlB;AACD,KAFD;AAIA,QAAIO,GAAG,CAACgD,UAAR,EAAoBhD,GAAG,CAACgD,UAAJ,CAAe,IAAf;AACpBhD,IAAAA,GAAG,CAACiD,GAAJ;AACD;;AAEDlD,EAAAA,OAAO;;AAEP,WAASJ,KAAT,GAAkB;AAChB,QAAIL,IAAI,CAAC4D,SAAL,CAAeC,SAAS,CAAC,CAAD,CAAxB,EAA6BV,MAA7B,GAAsC,CAA1C,EAA6C;AAC3CnD,MAAAA,IAAI,CAAC8D,IAAL,CAAUC,KAAV,CAAgB/D,IAAhB,EAAsB6D,SAAtB;AACD;AACF;;AAED,OAAKG,MAAL,GAAc,YAAY;AACxB,QAAIrE,UAAU,KAAKH,WAAW,CAACY,MAA/B,EAAuC;AACvCT,IAAAA,UAAU,GAAGH,WAAW,CAACY,MAAzB;AACA,QAAIM,GAAG,CAACuD,KAAR,EAAevD,GAAG,CAACuD,KAAJ;AACf,QAAIvD,GAAG,CAACwD,GAAJ,IAAWxD,GAAG,CAACwD,GAAJ,CAAQD,KAAvB,EAA8BvD,GAAG,CAACwD,GAAJ,CAAQD,KAAR;AAC/B,GALD;;AAOA,WAAST,oBAAT,CAA+BpE,GAA/B,EAAoCgE,GAApC,EAAyCE,WAAzC,EAAsDD,UAAtD,EAAkE;AAChE,QAAIA,UAAU,KAAK,CAAnB,EAAsB;AACpB,UAAIvC,IAAI,CAACqC,MAAL,GAAc,CAAlB,EAAqB;AACnB,YAAIgB,IAAI,GAAGpD,SAAS,IAAI,SAAxB;;AACAV,QAAAA,KAAK,CAAC8D,IAAD,EAAO,IAAIC,YAAJ,CAAiBD,IAAjB,EAAuB;AACjCrD,UAAAA,IAAI,EAAEA,IAAI,CAACoC,KAAL,CAAW,CAAX,EAAc,CAAC,CAAf,CAD2B;AACR;AACzBvC,UAAAA,WAAW,EAAEA,WAFoB;AAGjC0D,UAAAA,MAAM,EAAE/F,QAAQ,CAACmB,GAAD;AAHiB,SAAvB,CAAP,CAAL;;AAKAqB,QAAAA,IAAI,GAAG,EAAP;AACD;;AACDC,MAAAA,SAAS,GAAG,KAAK,CAAjB;AACD,KAXD,MAWO,IAAIuC,WAAW,GAAG,CAAlB,EAAqB;AAC1B,UAAIgB,OAAO,GAAGhB,WAAW,GAAG,CAA5B;AACA,UAAIiB,IAAI,GAAG,CAAX;AACA,UAAIC,KAAK,GAAGpF,GAAG,CAAC8D,KAAJ,CAAUE,GAAV,EAAeA,GAAG,IAAIkB,OAAO,GAAGjB,UAAH,GAAgBC,WAA3B,CAAlB,EAA2DmB,QAA3D,EAAZ;;AAEA,UAAIH,OAAJ,EAAa;AACXC,QAAAA,IAAI,GAAGlB,UAAP;AACD,OAFD,MAEO,IAAIjE,GAAG,CAACgE,GAAG,GAAGE,WAAN,GAAoB,CAArB,CAAH,KAA+BtE,KAAnC,EAA0C;AAC/CuF,QAAAA,IAAI,GAAGjB,WAAW,GAAG,CAArB;AACD,OAFM,MAEA;AACLiB,QAAAA,IAAI,GAAGjB,WAAW,GAAG,CAArB;AACD;;AACDF,MAAAA,GAAG,IAAImB,IAAP;AAEA,UAAIG,WAAW,GAAGrB,UAAU,GAAGkB,IAA/B;AACA,UAAII,KAAK,GAAGvF,GAAG,CAAC8D,KAAJ,CAAUE,GAAV,EAAeA,GAAG,GAAGsB,WAArB,EAAkCD,QAAlC,EAAZ;;AAEA,UAAID,KAAK,KAAK,MAAd,EAAsB;AACpB1D,QAAAA,IAAI,IAAI6D,KAAK,GAAG,IAAhB;AACD,OAFD,MAEO,IAAIH,KAAK,KAAK,OAAd,EAAuB;AAC5BzD,QAAAA,SAAS,GAAG4D,KAAZ;AACD,OAFM,MAEA,IAAIH,KAAK,KAAK,IAAd,EAAoB;AACzB7D,QAAAA,WAAW,GAAGgE,KAAd;AACD,OAFM,MAEA,IAAIH,KAAK,KAAK,OAAd,EAAuB;AAC5B,YAAII,KAAK,GAAGC,QAAQ,CAACF,KAAD,EAAQ,EAAR,CAApB;;AACA,YAAI,CAACG,MAAM,CAACC,KAAP,CAAaH,KAAb,CAAL,EAA0B;AACxB5E,UAAAA,IAAI,CAACC,iBAAL,GAAyB2E,KAAzB;AACD;AACF;AACF;AACF;AACF;;AAEDI,MAAM,CAACC,OAAP,GAAiBzF,WAAjB;AAEAZ,IAAI,CAACsG,QAAL,CAAc1F,WAAd,EAA2Bf,MAAM,CAAC0G,YAAlC;AACA3F,WAAW,CAAC4F,SAAZ,CAAsBC,WAAtB,GAAoC7F,WAApC,C,CAAiD;;AAEjD,CAAC,MAAD,EAAS,OAAT,EAAkB,SAAlB,EAA6B8F,OAA7B,CAAqC,UAAUC,MAAV,EAAkB;AACrD1F,EAAAA,MAAM,CAACC,cAAP,CAAsBN,WAAW,CAAC4F,SAAlC,EAA6C,OAAOG,MAApD,EAA4D;AAC1D;AACJ;AACA;AACA;AACA;AACA;AACIxF,IAAAA,GAAG,EAAE,SAASA,GAAT,GAAgB;AACnB,UAAIyF,QAAQ,GAAG,KAAK5B,SAAL,CAAe2B,MAAf,EAAuB,CAAvB,CAAf;AACA,aAAOC,QAAQ,GAAIA,QAAQ,CAACC,SAAT,GAAqBD,QAAQ,CAACC,SAA9B,GAA0CD,QAA9C,GAA0DxD,SAAzE;AACD,KAVyD;;AAY1D;AACJ;AACA;AACA;AACA;AACA;AACA;AACI0D,IAAAA,GAAG,EAAE,SAASA,GAAT,CAAcF,QAAd,EAAwB;AAC3B,WAAK3C,kBAAL,CAAwB0C,MAAxB;AACA,WAAKI,gBAAL,CAAsBJ,MAAtB,EAA8BC,QAA9B;AACD;AAtByD,GAA5D;AAwBD,CAzBD;AA2BA;AACA;AACA;;AACA3F,MAAM,CAACC,cAAP,CAAsBN,WAAtB,EAAmC,YAAnC,EAAiD;AAACoG,EAAAA,UAAU,EAAE,IAAb;AAAmBjB,EAAAA,KAAK,EAAE;AAA1B,CAAjD;AACA9E,MAAM,CAACC,cAAP,CAAsBN,WAAtB,EAAmC,MAAnC,EAA2C;AAACoG,EAAAA,UAAU,EAAE,IAAb;AAAmBjB,EAAAA,KAAK,EAAE;AAA1B,CAA3C;AACA9E,MAAM,CAACC,cAAP,CAAsBN,WAAtB,EAAmC,QAAnC,EAA6C;AAACoG,EAAAA,UAAU,EAAE,IAAb;AAAmBjB,EAAAA,KAAK,EAAE;AAA1B,CAA7C;AAEAnF,WAAW,CAAC4F,SAAZ,CAAsBxF,UAAtB,GAAmC,CAAnC;AACAJ,WAAW,CAAC4F,SAAZ,CAAsBzC,IAAtB,GAA6B,CAA7B;AACAnD,WAAW,CAAC4F,SAAZ,CAAsBhF,MAAtB,GAA+B,CAA/B;AAEA;AACA;AACA;AACA;AACA;AACA;;AACAZ,WAAW,CAAC4F,SAAZ,CAAsB1C,KAAtB,GAA8B,YAAY;AACxC,OAAKsB,MAAL;AACD,CAFD;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACAxE,WAAW,CAAC4F,SAAZ,CAAsBO,gBAAtB,GAAyC,SAASA,gBAAT,CAA2BxB,IAA3B,EAAiCqB,QAAjC,EAA2C;AAClF,MAAI,OAAOA,QAAP,KAAoB,UAAxB,EAAoC;AAClC;AACAA,IAAAA,QAAQ,CAACC,SAAT,GAAqBD,QAArB;AACA,SAAK5C,EAAL,CAAQuB,IAAR,EAAcqB,QAAd;AACD;AACF,CAND;AAQA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACAhG,WAAW,CAAC4F,SAAZ,CAAsBS,aAAtB,GAAsC,SAASA,aAAT,CAAwBC,KAAxB,EAA+B;AACnE,MAAI,CAACA,KAAK,CAAC3B,IAAX,EAAiB;AACf,UAAM,IAAI4B,KAAJ,CAAU,4BAAV,CAAN;AACD,GAHkE,CAInE;AACA;;;AACA,OAAKjC,IAAL,CAAUgC,KAAK,CAAC3B,IAAhB,EAAsB2B,KAAK,CAACE,MAA5B;AACD,CAPD;AASA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACAxG,WAAW,CAAC4F,SAAZ,CAAsBa,mBAAtB,GAA4C,SAASA,mBAAT,CAA8B9B,IAA9B,EAAoCqB,QAApC,EAA8C;AACxF,MAAI,OAAOA,QAAP,KAAoB,UAAxB,EAAoC;AAClCA,IAAAA,QAAQ,CAACC,SAAT,GAAqBzD,SAArB;AACA,SAAKkE,cAAL,CAAoB/B,IAApB,EAA0BqB,QAA1B;AACD;AACF,CALD;AAOA;AACA;AACA;AACA;AACA;AACA;;;AACA,SAASlF,KAAT,CAAgB6D,IAAhB,EAAsBgC,kBAAtB,EAA0C;AACxCtG,EAAAA,MAAM,CAACC,cAAP,CAAsB,IAAtB,EAA4B,MAA5B,EAAoC;AAAEsG,IAAAA,QAAQ,EAAE,KAAZ;AAAmBzB,IAAAA,KAAK,EAAER,IAA1B;AAAgCyB,IAAAA,UAAU,EAAE;AAA5C,GAApC;;AACA,MAAIO,kBAAJ,EAAwB;AACtB,SAAK,IAAIE,CAAT,IAAcF,kBAAd,EAAkC;AAChC,UAAIA,kBAAkB,CAACG,cAAnB,CAAkCD,CAAlC,CAAJ,EAA0C;AACxCxG,QAAAA,MAAM,CAACC,cAAP,CAAsB,IAAtB,EAA4BuG,CAA5B,EAA+B;AAAED,UAAAA,QAAQ,EAAE,KAAZ;AAAmBzB,UAAAA,KAAK,EAAEwB,kBAAkB,CAACE,CAAD,CAA5C;AAAiDT,UAAAA,UAAU,EAAE;AAA7D,SAA/B;AACD;AACF;AACF;AACF;AAED;AACA;AACA;AACA;AACA;AACA;;;AACA,SAASxB,YAAT,CAAuBD,IAAvB,EAA6BoC,aAA7B,EAA4C;AAC1C1G,EAAAA,MAAM,CAACC,cAAP,CAAsB,IAAtB,EAA4B,MAA5B,EAAoC;AAAEsG,IAAAA,QAAQ,EAAE,KAAZ;AAAmBzB,IAAAA,KAAK,EAAER,IAA1B;AAAgCyB,IAAAA,UAAU,EAAE;AAA5C,GAApC;;AACA,OAAK,IAAIS,CAAT,IAAcE,aAAd,EAA6B;AAC3B,QAAIA,aAAa,CAACD,cAAd,CAA6BD,CAA7B,CAAJ,EAAqC;AACnCxG,MAAAA,MAAM,CAACC,cAAP,CAAsB,IAAtB,EAA4BuG,CAA5B,EAA+B;AAAED,QAAAA,QAAQ,EAAE,KAAZ;AAAmBzB,QAAAA,KAAK,EAAE4B,aAAa,CAACF,CAAD,CAAvC;AAA4CT,QAAAA,UAAU,EAAE;AAAxD,OAA/B;AACD;AACF;AACF","sourcesContent":["var original = require('original')\nvar parse = require('url').parse\nvar events = require('events')\nvar https = require('https')\nvar http = require('http')\nvar util = require('util')\n\nvar httpsOptions = [\n  'pfx', 'key', 'passphrase', 'cert', 'ca', 'ciphers',\n  'rejectUnauthorized', 'secureProtocol', 'servername', 'checkServerIdentity'\n]\n\nvar bom = [239, 187, 191]\nvar colon = 58\nvar space = 32\nvar lineFeed = 10\nvar carriageReturn = 13\n\nfunction hasBom (buf) {\n  return bom.every(function (charCode, index) {\n    return buf[index] === charCode\n  })\n}\n\n/**\n * Creates a new EventSource object\n *\n * @param {String} url the URL to which to connect\n * @param {Object} [eventSourceInitDict] extra init params. See README for details.\n * @api public\n **/\nfunction EventSource (url, eventSourceInitDict) {\n  var readyState = EventSource.CONNECTING\n  Object.defineProperty(this, 'readyState', {\n    get: function () {\n      return readyState\n    }\n  })\n\n  Object.defineProperty(this, 'url', {\n    get: function () {\n      return url\n    }\n  })\n\n  var self = this\n  self.reconnectInterval = 1000\n\n  function onConnectionClosed (message) {\n    if (readyState === EventSource.CLOSED) return\n    readyState = EventSource.CONNECTING\n    _emit('error', new Event('error', {message: message}))\n\n    // The url may have been changed by a temporary\n    // redirect. If that's the case, revert it now.\n    if (reconnectUrl) {\n      url = reconnectUrl\n      reconnectUrl = null\n    }\n    setTimeout(function () {\n      if (readyState !== EventSource.CONNECTING) {\n        return\n      }\n      connect()\n    }, self.reconnectInterval)\n  }\n\n  var req\n  var lastEventId = ''\n  if (eventSourceInitDict && eventSourceInitDict.headers && eventSourceInitDict.headers['Last-Event-ID']) {\n    lastEventId = eventSourceInitDict.headers['Last-Event-ID']\n    delete eventSourceInitDict.headers['Last-Event-ID']\n  }\n\n  var discardTrailingNewline = false\n  var data = ''\n  var eventName = ''\n\n  var reconnectUrl = null\n\n  function connect () {\n    var options = parse(url)\n    var isSecure = options.protocol === 'https:'\n    options.headers = { 'Cache-Control': 'no-cache', 'Accept': 'text/event-stream' }\n    if (lastEventId) options.headers['Last-Event-ID'] = lastEventId\n    if (eventSourceInitDict && eventSourceInitDict.headers) {\n      for (var i in eventSourceInitDict.headers) {\n        var header = eventSourceInitDict.headers[i]\n        if (header) {\n          options.headers[i] = header\n        }\n      }\n    }\n\n    // Legacy: this should be specified as `eventSourceInitDict.https.rejectUnauthorized`,\n    // but for now exists as a backwards-compatibility layer\n    options.rejectUnauthorized = !(eventSourceInitDict && !eventSourceInitDict.rejectUnauthorized)\n\n    // If specify http proxy, make the request to sent to the proxy server,\n    // and include the original url in path and Host headers\n    var useProxy = eventSourceInitDict && eventSourceInitDict.proxy\n    if (useProxy) {\n      var proxy = parse(eventSourceInitDict.proxy)\n      isSecure = proxy.protocol === 'https:'\n\n      options.protocol = isSecure ? 'https:' : 'http:'\n      options.path = url\n      options.headers.Host = options.host\n      options.hostname = proxy.hostname\n      options.host = proxy.host\n      options.port = proxy.port\n    }\n\n    // If https options are specified, merge them into the request options\n    if (eventSourceInitDict && eventSourceInitDict.https) {\n      for (var optName in eventSourceInitDict.https) {\n        if (httpsOptions.indexOf(optName) === -1) {\n          continue\n        }\n\n        var option = eventSourceInitDict.https[optName]\n        if (option !== undefined) {\n          options[optName] = option\n        }\n      }\n    }\n\n    // Pass this on to the XHR\n    if (eventSourceInitDict && eventSourceInitDict.withCredentials !== undefined) {\n      options.withCredentials = eventSourceInitDict.withCredentials\n    }\n\n    req = (isSecure ? https : http).request(options, function (res) {\n      // Handle HTTP errors\n      if (res.statusCode === 500 || res.statusCode === 502 || res.statusCode === 503 || res.statusCode === 504) {\n        _emit('error', new Event('error', {status: res.statusCode, message: res.statusMessage}))\n        onConnectionClosed()\n        return\n      }\n\n      // Handle HTTP redirects\n      if (res.statusCode === 301 || res.statusCode === 307) {\n        if (!res.headers.location) {\n          // Server sent redirect response without Location header.\n          _emit('error', new Event('error', {status: res.statusCode, message: res.statusMessage}))\n          return\n        }\n        if (res.statusCode === 307) reconnectUrl = url\n        url = res.headers.location\n        process.nextTick(connect)\n        return\n      }\n\n      if (res.statusCode !== 200) {\n        _emit('error', new Event('error', {status: res.statusCode, message: res.statusMessage}))\n        return self.close()\n      }\n\n      readyState = EventSource.OPEN\n      res.on('close', function () {\n        res.removeAllListeners('close')\n        res.removeAllListeners('end')\n        onConnectionClosed()\n      })\n\n      res.on('end', function () {\n        res.removeAllListeners('close')\n        res.removeAllListeners('end')\n        onConnectionClosed()\n      })\n      _emit('open', new Event('open'))\n\n      // text/event-stream parser adapted from webkit's\n      // Source/WebCore/page/EventSource.cpp\n      var isFirst = true\n      var buf\n      res.on('data', function (chunk) {\n        buf = buf ? Buffer.concat([buf, chunk]) : chunk\n        if (isFirst && hasBom(buf)) {\n          buf = buf.slice(bom.length)\n        }\n\n        isFirst = false\n        var pos = 0\n        var length = buf.length\n\n        while (pos < length) {\n          if (discardTrailingNewline) {\n            if (buf[pos] === lineFeed) {\n              ++pos\n            }\n            discardTrailingNewline = false\n          }\n\n          var lineLength = -1\n          var fieldLength = -1\n          var c\n\n          for (var i = pos; lineLength < 0 && i < length; ++i) {\n            c = buf[i]\n            if (c === colon) {\n              if (fieldLength < 0) {\n                fieldLength = i - pos\n              }\n            } else if (c === carriageReturn) {\n              discardTrailingNewline = true\n              lineLength = i - pos\n            } else if (c === lineFeed) {\n              lineLength = i - pos\n            }\n          }\n\n          if (lineLength < 0) {\n            break\n          }\n\n          parseEventStreamLine(buf, pos, fieldLength, lineLength)\n\n          pos += lineLength + 1\n        }\n\n        if (pos === length) {\n          buf = void 0\n        } else if (pos > 0) {\n          buf = buf.slice(pos)\n        }\n      })\n    })\n\n    req.on('error', function (err) {\n      onConnectionClosed(err.message)\n    })\n\n    if (req.setNoDelay) req.setNoDelay(true)\n    req.end()\n  }\n\n  connect()\n\n  function _emit () {\n    if (self.listeners(arguments[0]).length > 0) {\n      self.emit.apply(self, arguments)\n    }\n  }\n\n  this._close = function () {\n    if (readyState === EventSource.CLOSED) return\n    readyState = EventSource.CLOSED\n    if (req.abort) req.abort()\n    if (req.xhr && req.xhr.abort) req.xhr.abort()\n  }\n\n  function parseEventStreamLine (buf, pos, fieldLength, lineLength) {\n    if (lineLength === 0) {\n      if (data.length > 0) {\n        var type = eventName || 'message'\n        _emit(type, new MessageEvent(type, {\n          data: data.slice(0, -1), // remove trailing newline\n          lastEventId: lastEventId,\n          origin: original(url)\n        }))\n        data = ''\n      }\n      eventName = void 0\n    } else if (fieldLength > 0) {\n      var noValue = fieldLength < 0\n      var step = 0\n      var field = buf.slice(pos, pos + (noValue ? lineLength : fieldLength)).toString()\n\n      if (noValue) {\n        step = lineLength\n      } else if (buf[pos + fieldLength + 1] !== space) {\n        step = fieldLength + 1\n      } else {\n        step = fieldLength + 2\n      }\n      pos += step\n\n      var valueLength = lineLength - step\n      var value = buf.slice(pos, pos + valueLength).toString()\n\n      if (field === 'data') {\n        data += value + '\\n'\n      } else if (field === 'event') {\n        eventName = value\n      } else if (field === 'id') {\n        lastEventId = value\n      } else if (field === 'retry') {\n        var retry = parseInt(value, 10)\n        if (!Number.isNaN(retry)) {\n          self.reconnectInterval = retry\n        }\n      }\n    }\n  }\n}\n\nmodule.exports = EventSource\n\nutil.inherits(EventSource, events.EventEmitter)\nEventSource.prototype.constructor = EventSource; // make stacktraces readable\n\n['open', 'error', 'message'].forEach(function (method) {\n  Object.defineProperty(EventSource.prototype, 'on' + method, {\n    /**\n     * Returns the current listener\n     *\n     * @return {Mixed} the set function or undefined\n     * @api private\n     */\n    get: function get () {\n      var listener = this.listeners(method)[0]\n      return listener ? (listener._listener ? listener._listener : listener) : undefined\n    },\n\n    /**\n     * Start listening for events\n     *\n     * @param {Function} listener the listener\n     * @return {Mixed} the set function or undefined\n     * @api private\n     */\n    set: function set (listener) {\n      this.removeAllListeners(method)\n      this.addEventListener(method, listener)\n    }\n  })\n})\n\n/**\n * Ready states\n */\nObject.defineProperty(EventSource, 'CONNECTING', {enumerable: true, value: 0})\nObject.defineProperty(EventSource, 'OPEN', {enumerable: true, value: 1})\nObject.defineProperty(EventSource, 'CLOSED', {enumerable: true, value: 2})\n\nEventSource.prototype.CONNECTING = 0\nEventSource.prototype.OPEN = 1\nEventSource.prototype.CLOSED = 2\n\n/**\n * Closes the connection, if one is made, and sets the readyState attribute to 2 (closed)\n *\n * @see https://developer.mozilla.org/en-US/docs/Web/API/EventSource/close\n * @api public\n */\nEventSource.prototype.close = function () {\n  this._close()\n}\n\n/**\n * Emulates the W3C Browser based WebSocket interface using addEventListener.\n *\n * @param {String} type A string representing the event type to listen out for\n * @param {Function} listener callback\n * @see https://developer.mozilla.org/en/DOM/element.addEventListener\n * @see http://dev.w3.org/html5/websockets/#the-websocket-interface\n * @api public\n */\nEventSource.prototype.addEventListener = function addEventListener (type, listener) {\n  if (typeof listener === 'function') {\n    // store a reference so we can return the original function again\n    listener._listener = listener\n    this.on(type, listener)\n  }\n}\n\n/**\n * Emulates the W3C Browser based WebSocket interface using dispatchEvent.\n *\n * @param {Event} event An event to be dispatched\n * @see https://developer.mozilla.org/en-US/docs/Web/API/EventTarget/dispatchEvent\n * @api public\n */\nEventSource.prototype.dispatchEvent = function dispatchEvent (event) {\n  if (!event.type) {\n    throw new Error('UNSPECIFIED_EVENT_TYPE_ERR')\n  }\n  // if event is instance of an CustomEvent (or has 'details' property),\n  // send the detail object as the payload for the event\n  this.emit(event.type, event.detail)\n}\n\n/**\n * Emulates the W3C Browser based WebSocket interface using removeEventListener.\n *\n * @param {String} type A string representing the event type to remove\n * @param {Function} listener callback\n * @see https://developer.mozilla.org/en/DOM/element.removeEventListener\n * @see http://dev.w3.org/html5/websockets/#the-websocket-interface\n * @api public\n */\nEventSource.prototype.removeEventListener = function removeEventListener (type, listener) {\n  if (typeof listener === 'function') {\n    listener._listener = undefined\n    this.removeListener(type, listener)\n  }\n}\n\n/**\n * W3C Event\n *\n * @see http://www.w3.org/TR/DOM-Level-3-Events/#interface-Event\n * @api private\n */\nfunction Event (type, optionalProperties) {\n  Object.defineProperty(this, 'type', { writable: false, value: type, enumerable: true })\n  if (optionalProperties) {\n    for (var f in optionalProperties) {\n      if (optionalProperties.hasOwnProperty(f)) {\n        Object.defineProperty(this, f, { writable: false, value: optionalProperties[f], enumerable: true })\n      }\n    }\n  }\n}\n\n/**\n * W3C MessageEvent\n *\n * @see http://www.w3.org/TR/webmessaging/#event-definitions\n * @api private\n */\nfunction MessageEvent (type, eventInitDict) {\n  Object.defineProperty(this, 'type', { writable: false, value: type, enumerable: true })\n  for (var f in eventInitDict) {\n    if (eventInitDict.hasOwnProperty(f)) {\n      Object.defineProperty(this, f, { writable: false, value: eventInitDict[f], enumerable: true })\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"script"}