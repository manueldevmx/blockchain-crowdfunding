{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Server = exports.SUBMIT_TRANSACTION_TIMEOUT = void 0;\n\nvar tslib_1 = require(\"tslib\");\n\nvar bignumber_js_1 = tslib_1.__importDefault(require(\"bignumber.js\"));\n\nvar isEmpty_1 = tslib_1.__importDefault(require(\"lodash/isEmpty\"));\n\nvar merge_1 = tslib_1.__importDefault(require(\"lodash/merge\"));\n\nvar stellar_base_1 = require(\"stellar-base\");\n\nvar urijs_1 = tslib_1.__importDefault(require(\"urijs\"));\n\nvar call_builder_1 = require(\"./call_builder\");\n\nvar config_1 = require(\"./config\");\n\nvar errors_1 = require(\"./errors\");\n\nvar account_call_builder_1 = require(\"./account_call_builder\");\n\nvar account_response_1 = require(\"./account_response\");\n\nvar assets_call_builder_1 = require(\"./assets_call_builder\");\n\nvar claimable_balances_call_builder_1 = require(\"./claimable_balances_call_builder\");\n\nvar effect_call_builder_1 = require(\"./effect_call_builder\");\n\nvar friendbot_builder_1 = require(\"./friendbot_builder\");\n\nvar ledger_call_builder_1 = require(\"./ledger_call_builder\");\n\nvar offer_call_builder_1 = require(\"./offer_call_builder\");\n\nvar operation_call_builder_1 = require(\"./operation_call_builder\");\n\nvar orderbook_call_builder_1 = require(\"./orderbook_call_builder\");\n\nvar payment_call_builder_1 = require(\"./payment_call_builder\");\n\nvar strict_receive_path_call_builder_1 = require(\"./strict_receive_path_call_builder\");\n\nvar strict_send_path_call_builder_1 = require(\"./strict_send_path_call_builder\");\n\nvar trade_aggregation_call_builder_1 = require(\"./trade_aggregation_call_builder\");\n\nvar trades_call_builder_1 = require(\"./trades_call_builder\");\n\nvar transaction_call_builder_1 = require(\"./transaction_call_builder\");\n\nvar horizon_axios_client_1 = tslib_1.__importStar(require(\"./horizon_axios_client\"));\n\nexports.SUBMIT_TRANSACTION_TIMEOUT = 60 * 1000;\nvar STROOPS_IN_LUMEN = 10000000;\nvar ACCOUNT_REQUIRES_MEMO = \"MQ==\";\n\nfunction _getAmountInLumens(amt) {\n  return new bignumber_js_1.default(amt).div(STROOPS_IN_LUMEN).toString();\n}\n\nvar Server = function () {\n  function Server(serverURL, opts) {\n    if (opts === void 0) {\n      opts = {};\n    }\n\n    this.serverURL = urijs_1.default(serverURL);\n    var allowHttp = typeof opts.allowHttp === \"undefined\" ? config_1.Config.isAllowHttp() : opts.allowHttp;\n    var customHeaders = {};\n\n    if (opts.appName) {\n      customHeaders[\"X-App-Name\"] = opts.appName;\n    }\n\n    if (opts.appVersion) {\n      customHeaders[\"X-App-Version\"] = opts.appVersion;\n    }\n\n    if (!isEmpty_1.default(customHeaders)) {\n      horizon_axios_client_1.default.interceptors.request.use(function (config) {\n        config.headers = merge_1.default(customHeaders, config.headers);\n        return config;\n      });\n    }\n\n    if (this.serverURL.protocol() !== \"https\" && !allowHttp) {\n      throw new Error(\"Cannot connect to insecure horizon server\");\n    }\n  }\n\n  Server.prototype.fetchTimebounds = function (seconds, _isRetry) {\n    if (_isRetry === void 0) {\n      _isRetry = false;\n    }\n\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n      var currentTime;\n      return tslib_1.__generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            currentTime = horizon_axios_client_1.getCurrentServerTime(this.serverURL.hostname());\n\n            if (currentTime) {\n              return [2, {\n                minTime: 0,\n                maxTime: currentTime + seconds\n              }];\n            }\n\n            if (_isRetry) {\n              return [2, {\n                minTime: 0,\n                maxTime: Math.floor(new Date().getTime() / 1000) + seconds\n              }];\n            }\n\n            return [4, horizon_axios_client_1.default.get(urijs_1.default(this.serverURL).toString())];\n\n          case 1:\n            _a.sent();\n\n            return [4, this.fetchTimebounds(seconds, true)];\n\n          case 2:\n            return [2, _a.sent()];\n        }\n      });\n    });\n  };\n\n  Server.prototype.fetchBaseFee = function () {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n      var response;\n      return tslib_1.__generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4, this.feeStats()];\n\n          case 1:\n            response = _a.sent();\n            return [2, parseInt(response.last_ledger_base_fee, 10) || 100];\n        }\n      });\n    });\n  };\n\n  Server.prototype.feeStats = function () {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n      var cb;\n      return tslib_1.__generator(this, function (_a) {\n        cb = new call_builder_1.CallBuilder(urijs_1.default(this.serverURL));\n        cb.filter.push([\"fee_stats\"]);\n        return [2, cb.call()];\n      });\n    });\n  };\n\n  Server.prototype.submitTransaction = function (transaction, opts) {\n    if (opts === void 0) {\n      opts = {\n        skipMemoRequiredCheck: false\n      };\n    }\n\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n      var tx;\n      return tslib_1.__generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (!!opts.skipMemoRequiredCheck) return [3, 2];\n            return [4, this.checkMemoRequired(transaction)];\n\n          case 1:\n            _a.sent();\n\n            _a.label = 2;\n\n          case 2:\n            tx = encodeURIComponent(transaction.toEnvelope().toXDR().toString(\"base64\"));\n            return [2, horizon_axios_client_1.default.post(urijs_1.default(this.serverURL).segment(\"transactions\").toString(), \"tx=\" + tx, {\n              timeout: exports.SUBMIT_TRANSACTION_TIMEOUT\n            }).then(function (response) {\n              if (!response.data.result_xdr) {\n                return response.data;\n              }\n\n              var responseXDR = stellar_base_1.xdr.TransactionResult.fromXDR(response.data.result_xdr, \"base64\");\n              var results = responseXDR.result().value();\n              var offerResults;\n              var hasManageOffer;\n\n              if (results.length) {\n                offerResults = results.map(function (result, i) {\n                  if (result.value().switch().name !== \"manageBuyOffer\" && result.value().switch().name !== \"manageSellOffer\") {\n                    return null;\n                  }\n\n                  hasManageOffer = true;\n                  var amountBought = new bignumber_js_1.default(0);\n                  var amountSold = new bignumber_js_1.default(0);\n                  var offerSuccess = result.value().value().success();\n                  var offersClaimed = offerSuccess.offersClaimed().map(function (offerClaimed) {\n                    var claimedOfferAmountBought = new bignumber_js_1.default(offerClaimed.amountBought().toString());\n                    var claimedOfferAmountSold = new bignumber_js_1.default(offerClaimed.amountSold().toString());\n                    amountBought = amountBought.add(claimedOfferAmountSold);\n                    amountSold = amountSold.add(claimedOfferAmountBought);\n                    var sold = stellar_base_1.Asset.fromOperation(offerClaimed.assetSold());\n                    var bought = stellar_base_1.Asset.fromOperation(offerClaimed.assetBought());\n                    var assetSold = {\n                      type: sold.getAssetType(),\n                      assetCode: sold.getCode(),\n                      issuer: sold.getIssuer()\n                    };\n                    var assetBought = {\n                      type: bought.getAssetType(),\n                      assetCode: bought.getCode(),\n                      issuer: bought.getIssuer()\n                    };\n                    return {\n                      sellerId: stellar_base_1.StrKey.encodeEd25519PublicKey(offerClaimed.sellerId().ed25519()),\n                      offerId: offerClaimed.offerId().toString(),\n                      assetSold: assetSold,\n                      amountSold: _getAmountInLumens(claimedOfferAmountSold),\n                      assetBought: assetBought,\n                      amountBought: _getAmountInLumens(claimedOfferAmountBought)\n                    };\n                  });\n                  var effect = offerSuccess.offer().switch().name;\n                  var currentOffer;\n\n                  if (typeof offerSuccess.offer().value === \"function\" && offerSuccess.offer().value()) {\n                    var offerXDR = offerSuccess.offer().value();\n                    currentOffer = {\n                      offerId: offerXDR.offerId().toString(),\n                      selling: {},\n                      buying: {},\n                      amount: _getAmountInLumens(offerXDR.amount().toString()),\n                      price: {\n                        n: offerXDR.price().n(),\n                        d: offerXDR.price().d()\n                      }\n                    };\n                    var selling = stellar_base_1.Asset.fromOperation(offerXDR.selling());\n                    currentOffer.selling = {\n                      type: selling.getAssetType(),\n                      assetCode: selling.getCode(),\n                      issuer: selling.getIssuer()\n                    };\n                    var buying = stellar_base_1.Asset.fromOperation(offerXDR.buying());\n                    currentOffer.buying = {\n                      type: buying.getAssetType(),\n                      assetCode: buying.getCode(),\n                      issuer: buying.getIssuer()\n                    };\n                  }\n\n                  return {\n                    offersClaimed: offersClaimed,\n                    effect: effect,\n                    operationIndex: i,\n                    currentOffer: currentOffer,\n                    amountBought: _getAmountInLumens(amountBought),\n                    amountSold: _getAmountInLumens(amountSold),\n                    isFullyOpen: !offersClaimed.length && effect !== \"manageOfferDeleted\",\n                    wasPartiallyFilled: !!offersClaimed.length && effect !== \"manageOfferDeleted\",\n                    wasImmediatelyFilled: !!offersClaimed.length && effect === \"manageOfferDeleted\",\n                    wasImmediatelyDeleted: !offersClaimed.length && effect === \"manageOfferDeleted\"\n                  };\n                }).filter(function (result) {\n                  return !!result;\n                });\n              }\n\n              return Object.assign({}, response.data, {\n                offerResults: hasManageOffer ? offerResults : undefined\n              });\n            }).catch(function (response) {\n              if (response instanceof Error) {\n                return Promise.reject(response);\n              }\n\n              return Promise.reject(new errors_1.BadResponseError(\"Transaction submission failed. Server responded: \" + response.status + \" \" + response.statusText, response.data));\n            })];\n        }\n      });\n    });\n  };\n\n  Server.prototype.accounts = function () {\n    return new account_call_builder_1.AccountCallBuilder(urijs_1.default(this.serverURL));\n  };\n\n  Server.prototype.claimableBalances = function () {\n    return new claimable_balances_call_builder_1.ClaimableBalanceCallBuilder(urijs_1.default(this.serverURL));\n  };\n\n  Server.prototype.ledgers = function () {\n    return new ledger_call_builder_1.LedgerCallBuilder(urijs_1.default(this.serverURL));\n  };\n\n  Server.prototype.transactions = function () {\n    return new transaction_call_builder_1.TransactionCallBuilder(urijs_1.default(this.serverURL));\n  };\n\n  Server.prototype.offers = function () {\n    return new offer_call_builder_1.OfferCallBuilder(urijs_1.default(this.serverURL));\n  };\n\n  Server.prototype.orderbook = function (selling, buying) {\n    return new orderbook_call_builder_1.OrderbookCallBuilder(urijs_1.default(this.serverURL), selling, buying);\n  };\n\n  Server.prototype.trades = function () {\n    return new trades_call_builder_1.TradesCallBuilder(urijs_1.default(this.serverURL));\n  };\n\n  Server.prototype.operations = function () {\n    return new operation_call_builder_1.OperationCallBuilder(urijs_1.default(this.serverURL));\n  };\n\n  Server.prototype.strictReceivePaths = function (source, destinationAsset, destinationAmount) {\n    return new strict_receive_path_call_builder_1.StrictReceivePathCallBuilder(urijs_1.default(this.serverURL), source, destinationAsset, destinationAmount);\n  };\n\n  Server.prototype.strictSendPaths = function (sourceAsset, sourceAmount, destination) {\n    return new strict_send_path_call_builder_1.StrictSendPathCallBuilder(urijs_1.default(this.serverURL), sourceAsset, sourceAmount, destination);\n  };\n\n  Server.prototype.payments = function () {\n    return new payment_call_builder_1.PaymentCallBuilder(urijs_1.default(this.serverURL));\n  };\n\n  Server.prototype.effects = function () {\n    return new effect_call_builder_1.EffectCallBuilder(urijs_1.default(this.serverURL));\n  };\n\n  Server.prototype.friendbot = function (address) {\n    return new friendbot_builder_1.FriendbotBuilder(urijs_1.default(this.serverURL), address);\n  };\n\n  Server.prototype.assets = function () {\n    return new assets_call_builder_1.AssetsCallBuilder(urijs_1.default(this.serverURL));\n  };\n\n  Server.prototype.loadAccount = function (accountId) {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n      var res;\n      return tslib_1.__generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4, this.accounts().accountId(accountId).call()];\n\n          case 1:\n            res = _a.sent();\n            return [2, new account_response_1.AccountResponse(res)];\n        }\n      });\n    });\n  };\n\n  Server.prototype.tradeAggregation = function (base, counter, start_time, end_time, resolution, offset) {\n    return new trade_aggregation_call_builder_1.TradeAggregationCallBuilder(urijs_1.default(this.serverURL), base, counter, start_time, end_time, resolution, offset);\n  };\n\n  Server.prototype.checkMemoRequired = function (transaction) {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n      var destinations, i, operation, destination, account, e_1;\n      return tslib_1.__generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (transaction instanceof stellar_base_1.FeeBumpTransaction) {\n              transaction = transaction.innerTransaction;\n            }\n\n            if (transaction.memo.type !== \"none\") {\n              return [2];\n            }\n\n            destinations = new Set();\n            i = 0;\n            _a.label = 1;\n\n          case 1:\n            if (!(i < transaction.operations.length)) return [3, 6];\n            operation = transaction.operations[i];\n\n            switch (operation.type) {\n              case \"payment\":\n              case \"pathPaymentStrictReceive\":\n              case \"pathPaymentStrictSend\":\n              case \"accountMerge\":\n                break;\n\n              default:\n                return [3, 5];\n            }\n\n            destination = operation.destination;\n\n            if (destinations.has(destination)) {\n              return [3, 5];\n            }\n\n            destinations.add(destination);\n\n            if (destination.startsWith(\"M\")) {\n              return [3, 5];\n            }\n\n            _a.label = 2;\n\n          case 2:\n            _a.trys.push([2, 4,, 5]);\n\n            return [4, this.loadAccount(destination)];\n\n          case 3:\n            account = _a.sent();\n\n            if (account.data_attr[\"config.memo_required\"] === ACCOUNT_REQUIRES_MEMO) {\n              throw new errors_1.AccountRequiresMemoError(\"account requires memo\", destination, i);\n            }\n\n            return [3, 5];\n\n          case 4:\n            e_1 = _a.sent();\n\n            if (e_1 instanceof errors_1.AccountRequiresMemoError) {\n              throw e_1;\n            }\n\n            if (!(e_1 instanceof errors_1.NotFoundError)) {\n              throw e_1;\n            }\n\n            return [3, 5];\n\n          case 5:\n            i++;\n            return [3, 1];\n\n          case 6:\n            return [2];\n        }\n      });\n    });\n  };\n\n  return Server;\n}();\n\nexports.Server = Server;","map":{"version":3,"sources":["../src/server.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.Server = exports.SUBMIT_TRANSACTION_TIMEOUT = void 0;\nvar tslib_1 = require(\"tslib\");\nvar bignumber_js_1 = tslib_1.__importDefault(require(\"bignumber.js\"));\nvar isEmpty_1 = tslib_1.__importDefault(require(\"lodash/isEmpty\"));\nvar merge_1 = tslib_1.__importDefault(require(\"lodash/merge\"));\nvar stellar_base_1 = require(\"stellar-base\");\nvar urijs_1 = tslib_1.__importDefault(require(\"urijs\"));\nvar call_builder_1 = require(\"./call_builder\");\nvar config_1 = require(\"./config\");\nvar errors_1 = require(\"./errors\");\nvar account_call_builder_1 = require(\"./account_call_builder\");\nvar account_response_1 = require(\"./account_response\");\nvar assets_call_builder_1 = require(\"./assets_call_builder\");\nvar claimable_balances_call_builder_1 = require(\"./claimable_balances_call_builder\");\nvar effect_call_builder_1 = require(\"./effect_call_builder\");\nvar friendbot_builder_1 = require(\"./friendbot_builder\");\nvar ledger_call_builder_1 = require(\"./ledger_call_builder\");\nvar offer_call_builder_1 = require(\"./offer_call_builder\");\nvar operation_call_builder_1 = require(\"./operation_call_builder\");\nvar orderbook_call_builder_1 = require(\"./orderbook_call_builder\");\nvar payment_call_builder_1 = require(\"./payment_call_builder\");\nvar strict_receive_path_call_builder_1 = require(\"./strict_receive_path_call_builder\");\nvar strict_send_path_call_builder_1 = require(\"./strict_send_path_call_builder\");\nvar trade_aggregation_call_builder_1 = require(\"./trade_aggregation_call_builder\");\nvar trades_call_builder_1 = require(\"./trades_call_builder\");\nvar transaction_call_builder_1 = require(\"./transaction_call_builder\");\nvar horizon_axios_client_1 = tslib_1.__importStar(require(\"./horizon_axios_client\"));\nexports.SUBMIT_TRANSACTION_TIMEOUT = 60 * 1000;\nvar STROOPS_IN_LUMEN = 10000000;\nvar ACCOUNT_REQUIRES_MEMO = \"MQ==\";\nfunction _getAmountInLumens(amt) {\n    return new bignumber_js_1.default(amt).div(STROOPS_IN_LUMEN).toString();\n}\nvar Server = (function () {\n    function Server(serverURL, opts) {\n        if (opts === void 0) { opts = {}; }\n        this.serverURL = urijs_1.default(serverURL);\n        var allowHttp = typeof opts.allowHttp === \"undefined\"\n            ? config_1.Config.isAllowHttp()\n            : opts.allowHttp;\n        var customHeaders = {};\n        if (opts.appName) {\n            customHeaders[\"X-App-Name\"] = opts.appName;\n        }\n        if (opts.appVersion) {\n            customHeaders[\"X-App-Version\"] = opts.appVersion;\n        }\n        if (!isEmpty_1.default(customHeaders)) {\n            horizon_axios_client_1.default.interceptors.request.use(function (config) {\n                config.headers = merge_1.default(customHeaders, config.headers);\n                return config;\n            });\n        }\n        if (this.serverURL.protocol() !== \"https\" && !allowHttp) {\n            throw new Error(\"Cannot connect to insecure horizon server\");\n        }\n    }\n    Server.prototype.fetchTimebounds = function (seconds, _isRetry) {\n        if (_isRetry === void 0) { _isRetry = false; }\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var currentTime;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        currentTime = horizon_axios_client_1.getCurrentServerTime(this.serverURL.hostname());\n                        if (currentTime) {\n                            return [2, {\n                                    minTime: 0,\n                                    maxTime: currentTime + seconds,\n                                }];\n                        }\n                        if (_isRetry) {\n                            return [2, {\n                                    minTime: 0,\n                                    maxTime: Math.floor(new Date().getTime() / 1000) + seconds,\n                                }];\n                        }\n                        return [4, horizon_axios_client_1.default.get(urijs_1.default(this.serverURL).toString())];\n                    case 1:\n                        _a.sent();\n                        return [4, this.fetchTimebounds(seconds, true)];\n                    case 2: return [2, _a.sent()];\n                }\n            });\n        });\n    };\n    Server.prototype.fetchBaseFee = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var response;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4, this.feeStats()];\n                    case 1:\n                        response = _a.sent();\n                        return [2, parseInt(response.last_ledger_base_fee, 10) || 100];\n                }\n            });\n        });\n    };\n    Server.prototype.feeStats = function () {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var cb;\n            return tslib_1.__generator(this, function (_a) {\n                cb = new call_builder_1.CallBuilder(urijs_1.default(this.serverURL));\n                cb.filter.push([\"fee_stats\"]);\n                return [2, cb.call()];\n            });\n        });\n    };\n    Server.prototype.submitTransaction = function (transaction, opts) {\n        if (opts === void 0) { opts = { skipMemoRequiredCheck: false }; }\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var tx;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (!!opts.skipMemoRequiredCheck) return [3, 2];\n                        return [4, this.checkMemoRequired(transaction)];\n                    case 1:\n                        _a.sent();\n                        _a.label = 2;\n                    case 2:\n                        tx = encodeURIComponent(transaction\n                            .toEnvelope()\n                            .toXDR()\n                            .toString(\"base64\"));\n                        return [2, horizon_axios_client_1.default.post(urijs_1.default(this.serverURL)\n                                .segment(\"transactions\")\n                                .toString(), \"tx=\" + tx, { timeout: exports.SUBMIT_TRANSACTION_TIMEOUT })\n                                .then(function (response) {\n                                if (!response.data.result_xdr) {\n                                    return response.data;\n                                }\n                                var responseXDR = stellar_base_1.xdr.TransactionResult\n                                    .fromXDR(response.data.result_xdr, \"base64\");\n                                var results = responseXDR.result().value();\n                                var offerResults;\n                                var hasManageOffer;\n                                if (results.length) {\n                                    offerResults = results\n                                        .map(function (result, i) {\n                                        if (result.value().switch().name !== \"manageBuyOffer\" &&\n                                            result.value().switch().name !== \"manageSellOffer\") {\n                                            return null;\n                                        }\n                                        hasManageOffer = true;\n                                        var amountBought = new bignumber_js_1.default(0);\n                                        var amountSold = new bignumber_js_1.default(0);\n                                        var offerSuccess = result\n                                            .value()\n                                            .value()\n                                            .success();\n                                        var offersClaimed = offerSuccess\n                                            .offersClaimed()\n                                            .map(function (offerClaimed) {\n                                            var claimedOfferAmountBought = new bignumber_js_1.default(offerClaimed.amountBought().toString());\n                                            var claimedOfferAmountSold = new bignumber_js_1.default(offerClaimed.amountSold().toString());\n                                            amountBought = amountBought.add(claimedOfferAmountSold);\n                                            amountSold = amountSold.add(claimedOfferAmountBought);\n                                            var sold = stellar_base_1.Asset.fromOperation(offerClaimed.assetSold());\n                                            var bought = stellar_base_1.Asset.fromOperation(offerClaimed.assetBought());\n                                            var assetSold = {\n                                                type: sold.getAssetType(),\n                                                assetCode: sold.getCode(),\n                                                issuer: sold.getIssuer(),\n                                            };\n                                            var assetBought = {\n                                                type: bought.getAssetType(),\n                                                assetCode: bought.getCode(),\n                                                issuer: bought.getIssuer(),\n                                            };\n                                            return {\n                                                sellerId: stellar_base_1.StrKey.encodeEd25519PublicKey(offerClaimed.sellerId().ed25519()),\n                                                offerId: offerClaimed.offerId().toString(),\n                                                assetSold: assetSold,\n                                                amountSold: _getAmountInLumens(claimedOfferAmountSold),\n                                                assetBought: assetBought,\n                                                amountBought: _getAmountInLumens(claimedOfferAmountBought),\n                                            };\n                                        });\n                                        var effect = offerSuccess.offer().switch().name;\n                                        var currentOffer;\n                                        if (typeof offerSuccess.offer().value === \"function\" &&\n                                            offerSuccess.offer().value()) {\n                                            var offerXDR = offerSuccess.offer().value();\n                                            currentOffer = {\n                                                offerId: offerXDR.offerId().toString(),\n                                                selling: {},\n                                                buying: {},\n                                                amount: _getAmountInLumens(offerXDR.amount().toString()),\n                                                price: {\n                                                    n: offerXDR.price().n(),\n                                                    d: offerXDR.price().d(),\n                                                },\n                                            };\n                                            var selling = stellar_base_1.Asset.fromOperation(offerXDR.selling());\n                                            currentOffer.selling = {\n                                                type: selling.getAssetType(),\n                                                assetCode: selling.getCode(),\n                                                issuer: selling.getIssuer(),\n                                            };\n                                            var buying = stellar_base_1.Asset.fromOperation(offerXDR.buying());\n                                            currentOffer.buying = {\n                                                type: buying.getAssetType(),\n                                                assetCode: buying.getCode(),\n                                                issuer: buying.getIssuer(),\n                                            };\n                                        }\n                                        return {\n                                            offersClaimed: offersClaimed,\n                                            effect: effect,\n                                            operationIndex: i,\n                                            currentOffer: currentOffer,\n                                            amountBought: _getAmountInLumens(amountBought),\n                                            amountSold: _getAmountInLumens(amountSold),\n                                            isFullyOpen: !offersClaimed.length && effect !== \"manageOfferDeleted\",\n                                            wasPartiallyFilled: !!offersClaimed.length && effect !== \"manageOfferDeleted\",\n                                            wasImmediatelyFilled: !!offersClaimed.length && effect === \"manageOfferDeleted\",\n                                            wasImmediatelyDeleted: !offersClaimed.length && effect === \"manageOfferDeleted\",\n                                        };\n                                    })\n                                        .filter(function (result) { return !!result; });\n                                }\n                                return Object.assign({}, response.data, {\n                                    offerResults: hasManageOffer ? offerResults : undefined,\n                                });\n                            })\n                                .catch(function (response) {\n                                if (response instanceof Error) {\n                                    return Promise.reject(response);\n                                }\n                                return Promise.reject(new errors_1.BadResponseError(\"Transaction submission failed. Server responded: \" + response.status + \" \" + response.statusText, response.data));\n                            })];\n                }\n            });\n        });\n    };\n    Server.prototype.accounts = function () {\n        return new account_call_builder_1.AccountCallBuilder(urijs_1.default(this.serverURL));\n    };\n    Server.prototype.claimableBalances = function () {\n        return new claimable_balances_call_builder_1.ClaimableBalanceCallBuilder(urijs_1.default(this.serverURL));\n    };\n    Server.prototype.ledgers = function () {\n        return new ledger_call_builder_1.LedgerCallBuilder(urijs_1.default(this.serverURL));\n    };\n    Server.prototype.transactions = function () {\n        return new transaction_call_builder_1.TransactionCallBuilder(urijs_1.default(this.serverURL));\n    };\n    Server.prototype.offers = function () {\n        return new offer_call_builder_1.OfferCallBuilder(urijs_1.default(this.serverURL));\n    };\n    Server.prototype.orderbook = function (selling, buying) {\n        return new orderbook_call_builder_1.OrderbookCallBuilder(urijs_1.default(this.serverURL), selling, buying);\n    };\n    Server.prototype.trades = function () {\n        return new trades_call_builder_1.TradesCallBuilder(urijs_1.default(this.serverURL));\n    };\n    Server.prototype.operations = function () {\n        return new operation_call_builder_1.OperationCallBuilder(urijs_1.default(this.serverURL));\n    };\n    Server.prototype.strictReceivePaths = function (source, destinationAsset, destinationAmount) {\n        return new strict_receive_path_call_builder_1.StrictReceivePathCallBuilder(urijs_1.default(this.serverURL), source, destinationAsset, destinationAmount);\n    };\n    Server.prototype.strictSendPaths = function (sourceAsset, sourceAmount, destination) {\n        return new strict_send_path_call_builder_1.StrictSendPathCallBuilder(urijs_1.default(this.serverURL), sourceAsset, sourceAmount, destination);\n    };\n    Server.prototype.payments = function () {\n        return new payment_call_builder_1.PaymentCallBuilder(urijs_1.default(this.serverURL));\n    };\n    Server.prototype.effects = function () {\n        return new effect_call_builder_1.EffectCallBuilder(urijs_1.default(this.serverURL));\n    };\n    Server.prototype.friendbot = function (address) {\n        return new friendbot_builder_1.FriendbotBuilder(urijs_1.default(this.serverURL), address);\n    };\n    Server.prototype.assets = function () {\n        return new assets_call_builder_1.AssetsCallBuilder(urijs_1.default(this.serverURL));\n    };\n    Server.prototype.loadAccount = function (accountId) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var res;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4, this.accounts()\n                            .accountId(accountId)\n                            .call()];\n                    case 1:\n                        res = _a.sent();\n                        return [2, new account_response_1.AccountResponse(res)];\n                }\n            });\n        });\n    };\n    Server.prototype.tradeAggregation = function (base, counter, start_time, end_time, resolution, offset) {\n        return new trade_aggregation_call_builder_1.TradeAggregationCallBuilder(urijs_1.default(this.serverURL), base, counter, start_time, end_time, resolution, offset);\n    };\n    Server.prototype.checkMemoRequired = function (transaction) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var destinations, i, operation, destination, account, e_1;\n            return tslib_1.__generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0:\n                        if (transaction instanceof stellar_base_1.FeeBumpTransaction) {\n                            transaction = transaction.innerTransaction;\n                        }\n                        if (transaction.memo.type !== \"none\") {\n                            return [2];\n                        }\n                        destinations = new Set();\n                        i = 0;\n                        _a.label = 1;\n                    case 1:\n                        if (!(i < transaction.operations.length)) return [3, 6];\n                        operation = transaction.operations[i];\n                        switch (operation.type) {\n                            case \"payment\":\n                            case \"pathPaymentStrictReceive\":\n                            case \"pathPaymentStrictSend\":\n                            case \"accountMerge\":\n                                break;\n                            default:\n                                return [3, 5];\n                        }\n                        destination = operation.destination;\n                        if (destinations.has(destination)) {\n                            return [3, 5];\n                        }\n                        destinations.add(destination);\n                        if (destination.startsWith(\"M\")) {\n                            return [3, 5];\n                        }\n                        _a.label = 2;\n                    case 2:\n                        _a.trys.push([2, 4, , 5]);\n                        return [4, this.loadAccount(destination)];\n                    case 3:\n                        account = _a.sent();\n                        if (account.data_attr[\"config.memo_required\"] === ACCOUNT_REQUIRES_MEMO) {\n                            throw new errors_1.AccountRequiresMemoError(\"account requires memo\", destination, i);\n                        }\n                        return [3, 5];\n                    case 4:\n                        e_1 = _a.sent();\n                        if (e_1 instanceof errors_1.AccountRequiresMemoError) {\n                            throw e_1;\n                        }\n                        if (!(e_1 instanceof errors_1.NotFoundError)) {\n                            throw e_1;\n                        }\n                        return [3, 5];\n                    case 5:\n                        i++;\n                        return [3, 1];\n                    case 6: return [2];\n                }\n            });\n        });\n    };\n    return Server;\n}());\nexports.Server = Server;\n//# sourceMappingURL=server.js.map"]},"metadata":{},"sourceType":"script"}