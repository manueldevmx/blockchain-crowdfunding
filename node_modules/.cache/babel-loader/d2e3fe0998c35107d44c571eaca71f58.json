{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.CallBuilder = void 0;\n\nvar tslib_1 = require(\"tslib\");\n\nvar detect_node_1 = tslib_1.__importDefault(require(\"detect-node\"));\n\nvar urijs_1 = tslib_1.__importDefault(require(\"urijs\"));\n\nvar URITemplate_1 = tslib_1.__importDefault(require(\"urijs/src/URITemplate\"));\n\nvar errors_1 = require(\"./errors\");\n\nvar horizon_axios_client_1 = tslib_1.__importDefault(require(\"./horizon_axios_client\"));\n\nvar version = require(\"../package.json\").version;\n\nvar JOINABLE = [\"transaction\"];\nvar EventSource;\nvar anyGlobal = global;\n\nif (anyGlobal.EventSource) {\n  EventSource = anyGlobal.EventSource;\n} else if (detect_node_1.default) {\n  EventSource = require(\"eventsource\");\n} else {\n  EventSource = anyGlobal.window.EventSource;\n}\n\nvar CallBuilder = function () {\n  function CallBuilder(serverUrl) {\n    this.url = serverUrl.clone();\n    this.filter = [];\n    this.originalSegments = this.url.segment() || [];\n  }\n\n  CallBuilder.prototype.call = function () {\n    var _this = this;\n\n    this.checkFilter();\n    return this._sendNormalRequest(this.url).then(function (r) {\n      return _this._parseResponse(r);\n    });\n  };\n\n  CallBuilder.prototype.stream = function (options) {\n    var _this = this;\n\n    if (options === void 0) {\n      options = {};\n    }\n\n    this.checkFilter();\n    this.url.setQuery(\"X-Client-Name\", \"js-stellar-sdk\");\n    this.url.setQuery(\"X-Client-Version\", version);\n    var es;\n    var timeout;\n\n    var createTimeout = function () {\n      timeout = setTimeout(function () {\n        if (es) {\n          es.close();\n        }\n\n        es = createEventSource();\n      }, options.reconnectTimeout || 15 * 1000);\n    };\n\n    var createEventSource = function () {\n      try {\n        es = new EventSource(_this.url.toString());\n      } catch (err) {\n        if (options.onerror) {\n          options.onerror(err);\n        }\n      }\n\n      createTimeout();\n\n      if (es) {\n        var closed_1 = false;\n\n        var onClose_1 = function () {\n          if (closed_1) {\n            return;\n          }\n\n          clearTimeout(timeout);\n          es.close();\n          createEventSource();\n          closed_1 = true;\n        };\n\n        var onMessage = function (message) {\n          if (message.type === \"close\") {\n            onClose_1();\n            return;\n          }\n\n          var result = message.data ? _this._parseRecord(JSON.parse(message.data)) : message;\n\n          if (result.paging_token) {\n            _this.url.setQuery(\"cursor\", result.paging_token);\n          }\n\n          clearTimeout(timeout);\n          createTimeout();\n\n          if (typeof options.onmessage !== \"undefined\") {\n            options.onmessage(result);\n          }\n        };\n\n        var onError = function (error) {\n          if (options.onerror) {\n            options.onerror(error);\n          }\n        };\n\n        if (es.addEventListener) {\n          es.addEventListener(\"message\", onMessage.bind(_this));\n          es.addEventListener(\"error\", onError.bind(_this));\n          es.addEventListener(\"close\", onClose_1.bind(_this));\n        } else {\n          es.onmessage = onMessage.bind(_this);\n          es.onerror = onError.bind(_this);\n        }\n      }\n\n      return es;\n    };\n\n    createEventSource();\n    return function close() {\n      clearTimeout(timeout);\n\n      if (es) {\n        es.close();\n      }\n    };\n  };\n\n  CallBuilder.prototype.cursor = function (cursor) {\n    this.url.setQuery(\"cursor\", cursor);\n    return this;\n  };\n\n  CallBuilder.prototype.limit = function (recordsNumber) {\n    this.url.setQuery(\"limit\", recordsNumber.toString());\n    return this;\n  };\n\n  CallBuilder.prototype.order = function (direction) {\n    this.url.setQuery(\"order\", direction);\n    return this;\n  };\n\n  CallBuilder.prototype.join = function (include) {\n    this.url.setQuery(\"join\", include);\n    return this;\n  };\n\n  CallBuilder.prototype.checkFilter = function () {\n    if (this.filter.length >= 2) {\n      throw new errors_1.BadRequestError(\"Too many filters specified\", this.filter);\n    }\n\n    if (this.filter.length === 1) {\n      var newSegment = this.originalSegments.concat(this.filter[0]);\n      this.url.segment(newSegment);\n    }\n  };\n\n  CallBuilder.prototype._requestFnForLink = function (link) {\n    var _this = this;\n\n    return function (opts) {\n      if (opts === void 0) {\n        opts = {};\n      }\n\n      return tslib_1.__awaiter(_this, void 0, void 0, function () {\n        var uri, template, r;\n        return tslib_1.__generator(this, function (_a) {\n          switch (_a.label) {\n            case 0:\n              if (link.templated) {\n                template = URITemplate_1.default(link.href);\n                uri = urijs_1.default(template.expand(opts));\n              } else {\n                uri = urijs_1.default(link.href);\n              }\n\n              return [4, this._sendNormalRequest(uri)];\n\n            case 1:\n              r = _a.sent();\n              return [2, this._parseResponse(r)];\n          }\n        });\n      });\n    };\n  };\n\n  CallBuilder.prototype._parseRecord = function (json) {\n    var _this = this;\n\n    if (!json._links) {\n      return json;\n    }\n\n    var _loop_1 = function (key) {\n      var n = json._links[key];\n      var included = false;\n\n      if (typeof json[key] !== \"undefined\") {\n        json[key + \"_attr\"] = json[key];\n        included = true;\n      }\n\n      if (included && JOINABLE.indexOf(key) >= 0) {\n        var record_1 = this_1._parseRecord(json[key]);\n\n        json[key] = function () {\n          return tslib_1.__awaiter(_this, void 0, void 0, function () {\n            return tslib_1.__generator(this, function (_a) {\n              return [2, record_1];\n            });\n          });\n        };\n      } else {\n        json[key] = this_1._requestFnForLink(n);\n      }\n    };\n\n    var this_1 = this;\n\n    for (var _i = 0, _a = Object.keys(json._links); _i < _a.length; _i++) {\n      var key = _a[_i];\n\n      _loop_1(key);\n    }\n\n    return json;\n  };\n\n  CallBuilder.prototype._sendNormalRequest = function (initialUrl) {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n      var url;\n      return tslib_1.__generator(this, function (_a) {\n        url = initialUrl;\n\n        if (url.authority() === \"\") {\n          url = url.authority(this.url.authority());\n        }\n\n        if (url.protocol() === \"\") {\n          url = url.protocol(this.url.protocol());\n        }\n\n        url.setQuery(\"c\", String(Math.random()));\n        return [2, horizon_axios_client_1.default.get(url.toString()).then(function (response) {\n          return response.data;\n        }).catch(this._handleNetworkError)];\n      });\n    });\n  };\n\n  CallBuilder.prototype._parseResponse = function (json) {\n    if (json._embedded && json._embedded.records) {\n      return this._toCollectionPage(json);\n    }\n\n    return this._parseRecord(json);\n  };\n\n  CallBuilder.prototype._toCollectionPage = function (json) {\n    var _this = this;\n\n    for (var i = 0; i < json._embedded.records.length; i += 1) {\n      json._embedded.records[i] = this._parseRecord(json._embedded.records[i]);\n    }\n\n    return {\n      records: json._embedded.records,\n      next: function () {\n        return tslib_1.__awaiter(_this, void 0, void 0, function () {\n          var r;\n          return tslib_1.__generator(this, function (_a) {\n            switch (_a.label) {\n              case 0:\n                return [4, this._sendNormalRequest(urijs_1.default(json._links.next.href))];\n\n              case 1:\n                r = _a.sent();\n                return [2, this._toCollectionPage(r)];\n            }\n          });\n        });\n      },\n      prev: function () {\n        return tslib_1.__awaiter(_this, void 0, void 0, function () {\n          var r;\n          return tslib_1.__generator(this, function (_a) {\n            switch (_a.label) {\n              case 0:\n                return [4, this._sendNormalRequest(urijs_1.default(json._links.prev.href))];\n\n              case 1:\n                r = _a.sent();\n                return [2, this._toCollectionPage(r)];\n            }\n          });\n        });\n      }\n    };\n  };\n\n  CallBuilder.prototype._handleNetworkError = function (error) {\n    return tslib_1.__awaiter(this, void 0, void 0, function () {\n      return tslib_1.__generator(this, function (_a) {\n        if (error.response && error.response.status && error.response.statusText) {\n          switch (error.response.status) {\n            case 404:\n              return [2, Promise.reject(new errors_1.NotFoundError(error.response.statusText, error.response.data))];\n\n            default:\n              return [2, Promise.reject(new errors_1.NetworkError(error.response.statusText, error.response.data))];\n          }\n        } else {\n          return [2, Promise.reject(new Error(error.message))];\n        }\n\n        return [2];\n      });\n    });\n  };\n\n  return CallBuilder;\n}();\n\nexports.CallBuilder = CallBuilder;","map":{"version":3,"sources":["../src/call_builder.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.CallBuilder = void 0;\nvar tslib_1 = require(\"tslib\");\nvar detect_node_1 = tslib_1.__importDefault(require(\"detect-node\"));\nvar urijs_1 = tslib_1.__importDefault(require(\"urijs\"));\nvar URITemplate_1 = tslib_1.__importDefault(require(\"urijs/src/URITemplate\"));\nvar errors_1 = require(\"./errors\");\nvar horizon_axios_client_1 = tslib_1.__importDefault(require(\"./horizon_axios_client\"));\nvar version = require(\"../package.json\").version;\nvar JOINABLE = [\"transaction\"];\nvar EventSource;\nvar anyGlobal = global;\nif (anyGlobal.EventSource) {\n    EventSource = anyGlobal.EventSource;\n}\nelse if (detect_node_1.default) {\n    EventSource = require(\"eventsource\");\n}\nelse {\n    EventSource = anyGlobal.window.EventSource;\n}\nvar CallBuilder = (function () {\n    function CallBuilder(serverUrl) {\n        this.url = serverUrl.clone();\n        this.filter = [];\n        this.originalSegments = this.url.segment() || [];\n    }\n    CallBuilder.prototype.call = function () {\n        var _this = this;\n        this.checkFilter();\n        return this._sendNormalRequest(this.url).then(function (r) {\n            return _this._parseResponse(r);\n        });\n    };\n    CallBuilder.prototype.stream = function (options) {\n        var _this = this;\n        if (options === void 0) { options = {}; }\n        this.checkFilter();\n        this.url.setQuery(\"X-Client-Name\", \"js-stellar-sdk\");\n        this.url.setQuery(\"X-Client-Version\", version);\n        var es;\n        var timeout;\n        var createTimeout = function () {\n            timeout = setTimeout(function () {\n                if (es) {\n                    es.close();\n                }\n                es = createEventSource();\n            }, options.reconnectTimeout || 15 * 1000);\n        };\n        var createEventSource = function () {\n            try {\n                es = new EventSource(_this.url.toString());\n            }\n            catch (err) {\n                if (options.onerror) {\n                    options.onerror(err);\n                }\n            }\n            createTimeout();\n            if (es) {\n                var closed_1 = false;\n                var onClose_1 = function () {\n                    if (closed_1) {\n                        return;\n                    }\n                    clearTimeout(timeout);\n                    es.close();\n                    createEventSource();\n                    closed_1 = true;\n                };\n                var onMessage = function (message) {\n                    if (message.type === \"close\") {\n                        onClose_1();\n                        return;\n                    }\n                    var result = message.data\n                        ? _this._parseRecord(JSON.parse(message.data))\n                        : message;\n                    if (result.paging_token) {\n                        _this.url.setQuery(\"cursor\", result.paging_token);\n                    }\n                    clearTimeout(timeout);\n                    createTimeout();\n                    if (typeof options.onmessage !== \"undefined\") {\n                        options.onmessage(result);\n                    }\n                };\n                var onError = function (error) {\n                    if (options.onerror) {\n                        options.onerror(error);\n                    }\n                };\n                if (es.addEventListener) {\n                    es.addEventListener(\"message\", onMessage.bind(_this));\n                    es.addEventListener(\"error\", onError.bind(_this));\n                    es.addEventListener(\"close\", onClose_1.bind(_this));\n                }\n                else {\n                    es.onmessage = onMessage.bind(_this);\n                    es.onerror = onError.bind(_this);\n                }\n            }\n            return es;\n        };\n        createEventSource();\n        return function close() {\n            clearTimeout(timeout);\n            if (es) {\n                es.close();\n            }\n        };\n    };\n    CallBuilder.prototype.cursor = function (cursor) {\n        this.url.setQuery(\"cursor\", cursor);\n        return this;\n    };\n    CallBuilder.prototype.limit = function (recordsNumber) {\n        this.url.setQuery(\"limit\", recordsNumber.toString());\n        return this;\n    };\n    CallBuilder.prototype.order = function (direction) {\n        this.url.setQuery(\"order\", direction);\n        return this;\n    };\n    CallBuilder.prototype.join = function (include) {\n        this.url.setQuery(\"join\", include);\n        return this;\n    };\n    CallBuilder.prototype.checkFilter = function () {\n        if (this.filter.length >= 2) {\n            throw new errors_1.BadRequestError(\"Too many filters specified\", this.filter);\n        }\n        if (this.filter.length === 1) {\n            var newSegment = this.originalSegments.concat(this.filter[0]);\n            this.url.segment(newSegment);\n        }\n    };\n    CallBuilder.prototype._requestFnForLink = function (link) {\n        var _this = this;\n        return function (opts) {\n            if (opts === void 0) { opts = {}; }\n            return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                var uri, template, r;\n                return tslib_1.__generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0:\n                            if (link.templated) {\n                                template = URITemplate_1.default(link.href);\n                                uri = urijs_1.default(template.expand(opts));\n                            }\n                            else {\n                                uri = urijs_1.default(link.href);\n                            }\n                            return [4, this._sendNormalRequest(uri)];\n                        case 1:\n                            r = _a.sent();\n                            return [2, this._parseResponse(r)];\n                    }\n                });\n            });\n        };\n    };\n    CallBuilder.prototype._parseRecord = function (json) {\n        var _this = this;\n        if (!json._links) {\n            return json;\n        }\n        var _loop_1 = function (key) {\n            var n = json._links[key];\n            var included = false;\n            if (typeof json[key] !== \"undefined\") {\n                json[key + \"_attr\"] = json[key];\n                included = true;\n            }\n            if (included && JOINABLE.indexOf(key) >= 0) {\n                var record_1 = this_1._parseRecord(json[key]);\n                json[key] = function () { return tslib_1.__awaiter(_this, void 0, void 0, function () { return tslib_1.__generator(this, function (_a) {\n                    return [2, record_1];\n                }); }); };\n            }\n            else {\n                json[key] = this_1._requestFnForLink(n);\n            }\n        };\n        var this_1 = this;\n        for (var _i = 0, _a = Object.keys(json._links); _i < _a.length; _i++) {\n            var key = _a[_i];\n            _loop_1(key);\n        }\n        return json;\n    };\n    CallBuilder.prototype._sendNormalRequest = function (initialUrl) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            var url;\n            return tslib_1.__generator(this, function (_a) {\n                url = initialUrl;\n                if (url.authority() === \"\") {\n                    url = url.authority(this.url.authority());\n                }\n                if (url.protocol() === \"\") {\n                    url = url.protocol(this.url.protocol());\n                }\n                url.setQuery(\"c\", String(Math.random()));\n                return [2, horizon_axios_client_1.default.get(url.toString())\n                        .then(function (response) { return response.data; })\n                        .catch(this._handleNetworkError)];\n            });\n        });\n    };\n    CallBuilder.prototype._parseResponse = function (json) {\n        if (json._embedded && json._embedded.records) {\n            return this._toCollectionPage(json);\n        }\n        return this._parseRecord(json);\n    };\n    CallBuilder.prototype._toCollectionPage = function (json) {\n        var _this = this;\n        for (var i = 0; i < json._embedded.records.length; i += 1) {\n            json._embedded.records[i] = this._parseRecord(json._embedded.records[i]);\n        }\n        return {\n            records: json._embedded.records,\n            next: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                var r;\n                return tslib_1.__generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0: return [4, this._sendNormalRequest(urijs_1.default(json._links.next.href))];\n                        case 1:\n                            r = _a.sent();\n                            return [2, this._toCollectionPage(r)];\n                    }\n                });\n            }); },\n            prev: function () { return tslib_1.__awaiter(_this, void 0, void 0, function () {\n                var r;\n                return tslib_1.__generator(this, function (_a) {\n                    switch (_a.label) {\n                        case 0: return [4, this._sendNormalRequest(urijs_1.default(json._links.prev.href))];\n                        case 1:\n                            r = _a.sent();\n                            return [2, this._toCollectionPage(r)];\n                    }\n                });\n            }); },\n        };\n    };\n    CallBuilder.prototype._handleNetworkError = function (error) {\n        return tslib_1.__awaiter(this, void 0, void 0, function () {\n            return tslib_1.__generator(this, function (_a) {\n                if (error.response && error.response.status && error.response.statusText) {\n                    switch (error.response.status) {\n                        case 404:\n                            return [2, Promise.reject(new errors_1.NotFoundError(error.response.statusText, error.response.data))];\n                        default:\n                            return [2, Promise.reject(new errors_1.NetworkError(error.response.statusText, error.response.data))];\n                    }\n                }\n                else {\n                    return [2, Promise.reject(new Error(error.message))];\n                }\n                return [2];\n            });\n        });\n    };\n    return CallBuilder;\n}());\nexports.CallBuilder = CallBuilder;\n//# sourceMappingURL=call_builder.js.map"]},"metadata":{},"sourceType":"script"}